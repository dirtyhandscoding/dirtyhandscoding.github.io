<!DOCTYPE html>
<html lang="en">
<head>
        <!-- load favicon from /images -->
        <link rel="icon" type="image/png" href="/images/favicon.png" />
        <!-- stgatilov: properly detect device width on a mobile -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/> 

        <meta charset="utf-8" />
        <title>Doom 3: C++ enhanced RTTI and memory debugging</title>
        <link rel="stylesheet" href="https://dirtyhandscoding.github.io/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Dirty hands coding Atom Feed" />
        <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Dirty hands coding RSS Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://dirtyhandscoding.github.io/">Dirty hands coding </a></h1>
                <nav><ul>
                    <li><a href="/archives.html">ARCHIVES</a></li>
                    <li><a href="/categories.html">CATEGORIES</a></li>
                    <li><a href="/tags.html">TAGS</a></li>
                    <li><a href="/pages/contact.html">CONTACT</a></li>
                </ul>
<form class="navbar-search" action="https://dirtyhandscoding.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);">
                        <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input">
                    </form>
                </nav>
<div id="submenu">
                    <ul>
                            <li><a href="https://dirtyhandscoding.github.io/category/cc.html">C/C++</a></li>
                            <li><a href="https://dirtyhandscoding.github.io/category/high-performance.html">High performance</a></li>
                            <li class="active"><a href="https://dirtyhandscoding.github.io/category/the-dark-mod.html">The Dark Mod</a></li>
                            <li><a href="https://dirtyhandscoding.github.io/category/uncategorized.html">Uncategorized</a></li>
                    </ul>
                <div>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://dirtyhandscoding.github.io/posts/doom-3-c-enhanced-rtti-and-memory-debugging.html" rel="bookmark"
           title="Permalink to Doom 3: C++ enhanced RTTI and memory debugging">Doom 3: C++ enhanced RTTI and memory debugging</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>19 July 2017</span>
	        <span>| in <a href="https://dirtyhandscoding.github.io/category/the-dark-mod.html">The Dark Mod</a></span>
<span>| tags: <a href="https://dirtyhandscoding.github.io/tag/idtech4.html">idtech4</a><a href="https://dirtyhandscoding.github.io/tag/memory-debugging.html">memory debugging</a></span>
</footer><!-- /.post-info -->      
      <p>Although Doom 3 was released 13 years ago, there is still of lot of interesting stuff to find in it. The main reason for that is: it was developed in the time of changes. The ID software team had just moved from C to C++ (using Visual C++ 6). Graphic cards were moving from fixed pipeline to programming pipeline, CPUs were getting SIMD extensions. All of this caused a lot of diversity in the code: crazy mix of C++/C/asm code, several renderer backends, code acceleration for MMX/SSE/AltiVec (yeah, Macs used PowerPC at that time). Not to mention tons of scripts and defs, including C++-like scripting language, and in-game GUI system.</p>
<p>I have to deal with Doom 3 engine in the context of <a href="http://www.thedarkmod.com">The Dark Mod</a> (TDM for short).</p>
<p>This article is about <strong>memory debugging</strong> configuration in Doom 3 SDK (more precisely, "Debug with inlines and memory log").</p>


<h3 id="example"><a class="toclink" href="#example">Example</a></h3>
<p>To get started, here are some messages dumped to game console in the memory debugging configuration (current version of TDM):</p>
<p><img src="https://dirtyhandscoding.github.io/images/0_doom3_typeinfo/uninitialized_warning_console.png" class="w600" /></p>
<p>Also, after exiting game, a file "tdm_main_leak_size.txt" appears with this data:</p>
<div class="highlight"><pre><span></span><code><span class="nl">size</span><span class="p">:</span> <span class="mi">40</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">3</span><span class="o">:</span> <span class="n">idlib</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">HashIndex</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">53</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">24</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">3</span><span class="o">:</span> <span class="n">idlib</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">HashIndex</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">50</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">22</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">212</span><span class="o">:</span> <span class="n">game</span><span class="o">/</span><span class="n">Game_local</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">7116</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">18</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">523</span><span class="o">:</span> <span class="n">idlib</span><span class="o">/</span><span class="n">Str</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">90</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">8</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">38</span><span class="o">:</span> <span class="nl">c</span><span class="p">:</span><span class="o">/</span><span class="n">thedarkmod</span><span class="o">/</span><span class="n">tdm</span><span class="o">/</span><span class="n">idlib</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">List</span><span class="p">.</span><span class="n">h</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">377</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">6</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">138</span><span class="o">:</span> <span class="n">game</span><span class="o">/</span><span class="n">DarkModGlobals</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">467</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">3</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">150</span><span class="o">:</span> <span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">0</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">3</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">35</span><span class="o">:</span> <span class="n">renderer</span><span class="o">/</span><span class="n">Model_md5</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">743</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">2</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">110</span><span class="o">:</span> <span class="n">game</span><span class="o">/</span><span class="n">darkModLAS</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">1282</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">1</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">8</span><span class="o">:</span> <span class="n">game</span><span class="o">/</span><span class="n">Objectives</span><span class="o">/</span><span class="n">ObjectiveLocation</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">72</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">0</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">39</span><span class="o">:</span> <span class="n">game</span><span class="o">/</span><span class="n">SndPropLoader</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">723</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">0</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">39</span><span class="o">:</span> <span class="n">game</span><span class="o">/</span><span class="n">SndProp</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">339</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">0</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">13</span><span class="o">:</span> <span class="n">game</span><span class="o">/</span><span class="n">SEED</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">3449</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">0</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">8</span><span class="o">:</span> <span class="n">renderer</span><span class="o">/</span><span class="n">draw_arb2</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">841</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">0</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">8</span><span class="o">:</span> <span class="nl">c</span><span class="p">:</span><span class="o">/</span><span class="n">thedarkmod</span><span class="o">/</span><span class="n">tdm</span><span class="o">/</span><span class="n">idlib</span><span class="o">/</span><span class="n">math</span><span class="o">/</span><span class="n">Polynomial</span><span class="p">.</span><span class="n">h</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">601</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">0</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">2</span><span class="o">:</span> <span class="n">framework</span><span class="o">/</span><span class="n">I18N</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">428</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">0</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">1</span><span class="o">:</span> <span class="n">framework</span><span class="o">/</span><span class="n">FileSystem</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">2756</span>
<span class="nl">size</span><span class="p">:</span> <span class="mi">0</span> <span class="n">KB</span><span class="p">,</span> <span class="nl">allocs</span><span class="p">:</span> <span class="mi">3</span><span class="o">:</span> <span class="n">game</span><span class="o">/</span><span class="n">EscapePointManager</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">181</span>
<span class="mi">1333</span> <span class="n">total</span> <span class="n">memory</span> <span class="n">blocks</span> <span class="n">allocated</span>
<span class="mi">134</span> <span class="n">KB</span> <span class="n">memory</span> <span class="n">allocated</span>
</code></pre></div>

<p>Memory leak detection does not feel new, but the fact that each message about uninitialized member contains the <u>exact name of the member</u> is quite intriguing.</p>
<h3 id="memory-debugging"><a class="toclink" href="#memory-debugging">Memory debugging</a></h3>
<p>First let's deal with the simpler part: memory heap debugging.
Looking at <a href="https://github.com/id-Software/DOOM-3/blob/master/neo/idlib/Heap.h">Heap.h</a>, we see that ID_DEBUG_MEMORY enables a special piece of code:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#else </span><span class="cm">/* ID_DEBUG_MEMORY */</span><span class="cp"></span>

<span class="kt">void</span> <span class="o">*</span> <span class="nf">Mem_Alloc</span><span class="p">(</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lineNumber</span> <span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span> <span class="nf">Mem_ClearedAlloc</span><span class="p">(</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lineNumber</span> <span class="p">);</span>
<span class="kt">void</span> <span class="nf">Mem_Free</span><span class="p">(</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lineNumber</span> <span class="p">);</span>
<span class="kt">char</span> <span class="o">*</span> <span class="nf">Mem_CopyString</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lineNumber</span> <span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span> <span class="nf">Mem_Alloc16</span><span class="p">(</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lineNumber</span> <span class="p">);</span>
<span class="kt">void</span> <span class="nf">Mem_Free16</span><span class="p">(</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lineNumber</span> <span class="p">);</span>

<span class="cp">#ifdef ID_REDIRECT_NEWDELETE</span>

<span class="kr">__inline</span> <span class="kt">void</span> <span class="o">*</span><span class="k">operator</span> <span class="k">new</span><span class="p">(</span> <span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lineNumber</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Mem_Alloc</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">lineNumber</span> <span class="p">);</span>
<span class="p">}</span>
<span class="kr">__inline</span> <span class="kt">void</span> <span class="k">operator</span> <span class="k">delete</span><span class="p">(</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lineNumber</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">Mem_Free</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">lineNumber</span> <span class="p">);</span>
<span class="p">}</span>
<span class="kr">__inline</span> <span class="kt">void</span> <span class="o">*</span><span class="k">operator</span> <span class="k">new</span><span class="p">[](</span> <span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lineNumber</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Mem_Alloc</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">lineNumber</span> <span class="p">);</span>
<span class="p">}</span>
<span class="kr">__inline</span> <span class="kt">void</span> <span class="k">operator</span> <span class="k">delete</span><span class="p">[](</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lineNumber</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">Mem_Free</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">lineNumber</span> <span class="p">);</span>
<span class="p">}</span>
<span class="kr">__inline</span> <span class="kt">void</span> <span class="o">*</span><span class="k">operator</span> <span class="k">new</span><span class="p">(</span> <span class="kt">size_t</span> <span class="n">s</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Mem_Alloc</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
<span class="p">}</span>
<span class="kr">__inline</span> <span class="kt">void</span> <span class="k">operator</span> <span class="k">delete</span><span class="p">(</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">Mem_Free</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
<span class="p">}</span>
<span class="kr">__inline</span> <span class="kt">void</span> <span class="o">*</span><span class="k">operator</span> <span class="k">new</span><span class="p">[](</span> <span class="kt">size_t</span> <span class="n">s</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Mem_Alloc</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
<span class="p">}</span>
<span class="kr">__inline</span> <span class="kt">void</span> <span class="k">operator</span> <span class="k">delete</span><span class="p">[](</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">Mem_Free</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ID_DEBUG_NEW new( 0, 0, __FILE__, __LINE__ )</span>
<span class="cp">#undef new</span>
<span class="cp">#define new ID_DEBUG_NEW</span>

<span class="cp">#endif</span>

<span class="cp">#define Mem_Alloc( size ) Mem_Alloc( size, __FILE__, __LINE__ )</span>
<span class="cp">#define Mem_ClearedAlloc( size ) Mem_ClearedAlloc( size, __FILE__, __LINE__ )</span>
<span class="cp">#define Mem_Free( ptr ) Mem_Free( ptr, __FILE__, __LINE__ )</span>
<span class="cp">#define Mem_CopyString( s ) Mem_CopyString( s, __FILE__, __LINE__ )</span>
<span class="cp">#define Mem_Alloc16( size ) Mem_Alloc16( size, __FILE__, __LINE__ )</span>
<span class="cp">#define Mem_Free16( ptr ) Mem_Free16( ptr, __FILE__, __LINE__ )</span>

<span class="cp">#endif </span><span class="cm">/* ID_DEBUG_MEMORY */</span><span class="cp"></span>
</code></pre></div>

<p>The first part declares debug versions of ID's memory allocation functions, each of them having additional parameters <em>filename</em> and <em>lineNumber</em>. Then global <em>operator new</em> and <em>operator delete</em> are overriden to capture all allocations done with standard new/delete. Again, they have additional parameters. After that the main source of issues comes: <em>new</em> keyword is redefined with a macro, which allows to capture file and line of each call automatically.</p>
<p>The <a href="https://github.com/id-Software/DOOM-3/blob/master/neo/idlib/Heap.cpp#L1559">implementation</a> of debug memory allocation looks like:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="o">*</span><span class="nf">Mem_AllocDebugMemory</span><span class="p">(</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span>
                    <span class="k">const</span> <span class="kt">int</span> <span class="n">lineNumber</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">align16</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">//...</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">mem_heap</span><span class="o">-&gt;</span><span class="n">Allocate</span><span class="p">(</span> <span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">debugMemory_t</span> <span class="p">)</span> <span class="p">);</span>
    <span class="n">Mem_UpdateAllocStats</span><span class="p">(</span> <span class="n">size</span> <span class="p">);</span>

    <span class="n">debugMemory_t</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">debugMemory_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">m</span><span class="o">-&gt;</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span><span class="p">;</span>
    <span class="n">m</span><span class="o">-&gt;</span><span class="n">lineNumber</span> <span class="o">=</span> <span class="n">lineNumber</span><span class="p">;</span>
    <span class="n">m</span><span class="o">-&gt;</span><span class="n">frameNumber</span> <span class="o">=</span> <span class="n">idLib</span><span class="o">::</span><span class="n">frameNumber</span><span class="p">;</span>
    <span class="n">m</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">m</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">mem_debugMemory</span><span class="p">;</span>
    <span class="n">m</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">mem_debugMemory</span> <span class="p">)</span>
        <span class="n">mem_debugMemory</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
    <span class="n">mem_debugMemory</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span> <span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">debugMemory_t</span> <span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Each user-returned block of memory is prepended by 32 bytes of data, stored in <em>debugMemory_t</em> struct. It captures some information about allocation.
When this memory is freed, <em>size</em> data member is used to update allocation stats and to provide some limited double-free detection. Since all the blocks are always linked in a doubly linked list, it is straight-forward to dump all used dynamic memory blocks at any moment, including doing so at program termination to detect memory leaks.</p>
<p>In order to see memory stats constantly during playing, you can type <em>com_showMemoryUsage 1</em> into the game console, and you'll see something like this:</p>
<p><img src="https://dirtyhandscoding.github.io/images/0_doom3_typeinfo/showmemoryusage.png" class="centered w600"  /></p>
<p>The main benefit of implementing memory profiling system yourself versus taking a ready third-party solution is that you can see exactly the data you need. In this case, per-frame allocation data is recorded and shown (which works thanks to <em>Mem_ClearFrameStats</em> being called each frame).</p>
<p>As for dumping memory blocks, there are three ways to do it:</p>
<ol>
    <li>Exit game and look into file <em>[tdm_game]_leak_location.txt</em> (contents were shown above): this way is used to detect memory leaks.</li>
    <li>Write <em>memoryDump</em> into game console and look into created file <em>memoryDump.txt. </em>This file contains all blocks alive, and can be used to perform additional offline analysis (<a href="https://yadi.sk/i/SbLJVMOe3L5rRy" target="_blank" rel="noopener">sample</a>).</li>
    <li>Write <em>memoryDumpCompressed -s</em> into game console and look into file <em>memoryDump.txt</em>. Unlike the previous command, this one shows per-allocation-site statistics sorted according to parameter (<em>-s</em> = by size), which is rather compact (300 lines):</li>
</ol>
<details>
    <summary>memoryDump.txt contents (click to display)</summary>

    :::cpp
    size: 256912 KB, allocs: 354: c:/thedarkmod/tdm/idlib/Allocators.h, line: 613
    size: 133217 KB, allocs: 4206: renderer/tr_main.cpp, line: 297
    size: 27157 KB, allocs: 34927: c:/thedarkmod/tdm/idlib/containers/List.h, line: 377
    size: 10240 KB, allocs: 10: c:/thedarkmod/tdm/idlib/Allocators.h, line: 378
    size: 5494 KB, allocs: 11682: framework/DeclManager.cpp, line: 1907
    size: 4466 KB, allocs: 2358: game/gamesys/Class.cpp, line: 468
    size: 2813 KB, allocs: 41174: cm/CollisionModel_load.cpp, line: 660
    size: 2693 KB, allocs: 103: c:/thedarkmod/tdm/idlib/Allocators.h, line: 80
    size: 2684 KB, allocs: 337: cm/CollisionModel_load.cpp, line: 2913
    size: 2449 KB, allocs: 46008: idlib/Str.cpp, line: 90
    size: 2086 KB, allocs: 309: renderer/Model_md5.cpp, line: 195
    size: 2048 KB, allocs: 2: renderer/CinematicFFMpeg.cpp, line: 607
    size: 1983 KB, allocs: 769: cm/CollisionModel_files.cpp, line: 337
    size: 1950 KB, allocs: 960: game/BrittleFracture.cpp, line: 331
    size: 1872 KB, allocs: 1546: renderer/Image_init.cpp, line: 1361
    size: 1762 KB, allocs: 764: cm/CollisionModel_files.cpp, line: 390
    size: 1679 KB, allocs: 1819: cm/CollisionModel_load.cpp, line: 596
    size: 1677 KB, allocs: 6173: idlib/containers/HashIndex.cpp, line: 50
    size: 1487 KB, allocs: 528: game/physics/Clip.cpp, line: 102
    size: 1131 KB, allocs: 13795: idlib/MapFile.cpp, line: 316
    size: 1121 KB, allocs: 12488: framework/DeclManager.cpp, line: 1701
    size: 1043 KB, allocs: 309: renderer/Model_md5.cpp, line: 196
    size: 1024 KB, allocs: 1: renderer/tr_main.cpp, line: 245
    size: 902 KB, allocs: 1200: cm/CollisionModel_load.cpp, line: 566
    size: 814 KB, allocs: 337: cm/CollisionModel_load.cpp, line: 2905
    size: 810 KB, allocs: 1572: renderer/RenderWorld.cpp, line: 254
    size: 759 KB, allocs: 3471: c:/thedarkmod/tdmframework/DeclManager.h, line: 228
    size: 691 KB, allocs: 680: cm/CollisionModel_files.cpp, line: 316
    size: 683 KB, allocs: 5212: idlib/containers/HashIndex.cpp, line: 53
    size: 669 KB, allocs: 27325: , line: 0
    size: 651 KB, allocs: 704: ui/Window.cpp, line: 2188
    size: 625 KB, allocs: 1: game/Game_local.cpp, line: 554
    size: 620 KB, allocs: 980: idlib/containers/HashIndex.cpp, line: 101
    size: 594 KB, allocs: 15207: c:/thedarkmod/tdm/idlib/containers/StrPool.h, line: 106
    size: 590 KB, allocs: 2200: c:/thedarkmod/tdm/idlib/containers/HashIndex.h, line: 159
    size: 512 KB, allocs: 1: renderer/CinematicID.cpp, line: 71
    size: 458 KB, allocs: 3912: game/anim/Anim_Blend.cpp, line: 3073
    size: 401 KB, allocs: 123: game/gamesys/Class.cpp, line: 161
    size: 367 KB, allocs: 7238: tools/compilers/aas/AASFile.cpp, line: 913
    size: 354 KB, allocs: 3776: sound/snd_cache.cpp, line: 98
    size: 309 KB, allocs: 769: cm/CollisionModel_files.cpp, line: 433
    size: 285 KB, allocs: 4876: idlib/MapFile.cpp, line: 540
    size: 283 KB, allocs: 1339: c:/thedarkmod/tdm/idlib/containers/List.h, line: 536
    size: 247 KB, allocs: 2181: c:/thedarkmod/tdm/idlib/containers/HashIndex.h, line: 166
    size: 215 KB, allocs: 4598: ui/GuiScript.cpp, line: 375
    size: 205 KB, allocs: 6590: game/OverlaySys.cpp, line: 245
    size: 205 KB, allocs: 6560: game/script/Script_Program.cpp, line: 1256
    size: 199 KB, allocs: 379: ui/Window.cpp, line: 2196
    size: 178 KB, allocs: 251: game/AF.cpp, line: 676
    size: 175 KB, allocs: 1000: idlib/MapFile.cpp, line: 125
    size: 172 KB, allocs: 1107: cm/CollisionModel_load.cpp, line: 530
    size: 164 KB, allocs: 860: framework/CVarSystem.cpp, line: 653
    size: 161 KB, allocs: 2292: idlib/MapFile.cpp, line: 379
    size: 159 KB, allocs: 1: game/physics/Clip.cpp, line: 714
    size: 159 KB, allocs: 3143: ui/RegExp.cpp, line: 246
    size: 159 KB, allocs: 1167: game/Entity.cpp, line: 5878
    size: 148 KB, allocs: 73: sound/snd_world.cpp, line: 200
    size: 142 KB, allocs: 111: renderer/RenderWorld.cpp, line: 408
    size: 136 KB, allocs: 4368: ui/Window.cpp, line: 1625
    size: 131 KB, allocs: 960: game/BrittleFracture.cpp, line: 1171
    size: 128 KB, allocs: 1: renderer/CinematicID.cpp, line: 70
    size: 121 KB, allocs: 3: game/ai/AAS_routing.cpp, line: 241
    size: 114 KB, allocs: 4499: c:/thedarkmod/tdm/idlib/math/Vector.h, line: 1727
    size: 107 KB, allocs: 3444: game/anim/Anim_Blend.cpp, line: 88
    size: 105 KB, allocs: 406: cm/CollisionModel_load.cpp, line: 625
    size: 91 KB, allocs: 835: renderer/ModelManager.cpp, line: 336
    size: 87 KB, allocs: 40: game/anim/Anim_Blend.cpp, line: 3289
    size: 83 KB, allocs: 1190: idlib/math/Ode.cpp, line: 32
    size: 77 KB, allocs: 2198: game/script/Script_Program.cpp, line: 1223
    size: 75 KB, allocs: 807: game/script/Script_Program.cpp, line: 1138
    size: 74 KB, allocs: 2260: c:/thedarkmod/tdm/idlib/containers/List.h, line: 419
    size: 69 KB, allocs: 1019: c:/thedarkmod/tdm/idlib/math/Matrix.h, line: 2308
    size: 68 KB, allocs: 2197: game/Entity.cpp, line: 1006
    size: 65 KB, allocs: 580: renderer/Material.cpp, line: 1540
    size: 65 KB, allocs: 1392: ui/Window.cpp, line: 1862
    size: 64 KB, allocs: 1: renderer/CinematicID.cpp, line: 68
    size: 60 KB, allocs: 3: game/ai/AAS_routing.cpp, line: 128
    size: 58 KB, allocs: 426: game/StimResponse/StimResponseCollection.cpp, line: 105
    size: 57 KB, allocs: 733: idlib/geometry/Winding.cpp, line: 36
    size: 53 KB, allocs: 55: ui/Window.cpp, line: 2253
    size: 52 KB, allocs: 450: game/anim/Anim_Blend.cpp, line: 3359
    size: 52 KB, allocs: 166: game/AF.cpp, line: 793
    size: 52 KB, allocs: 215: game/StimResponse/StimResponseCollection.cpp, line: 91
    size: 51 KB, allocs: 397: game/anim/Anim.cpp, line: 976
    size: 49 KB, allocs: 38: ui/Window.cpp, line: 2220
    size: 48 KB, allocs: 512: game/script/Script_Program.cpp, line: 1124
    size: 45 KB, allocs: 162: game/physics/Physics_AF.cpp, line: 1061
    size: 44 KB, allocs: 369: game/ai/AAS_routing.cpp, line: 52
    size: 38 KB, allocs: 64: framework/DeclAF.cpp, line: 786
    size: 37 KB, allocs: 599: framework/DeclManager.cpp, line: 998
    size: 35 KB, allocs: 1148: ui/GuiScript.cpp, line: 520
    size: 34 KB, allocs: 251: game/AF.cpp, line: 673
    size: 32 KB, allocs: 299: renderer/ModelManager.cpp, line: 282
    size: 32 KB, allocs: 1: cm/CollisionModel_load.cpp, line: 3385
    size: 32 KB, allocs: 1: renderer/CinematicID.cpp, line: 69
    size: 31 KB, allocs: 230: game/Moveable.cpp, line: 193
    size: 28 KB, allocs: 1961: c:/thedarkmod/tdm/ui/Winvar.h, line: 44
    size: 23 KB, allocs: 82: framework/DeclParticle.cpp, line: 213
    size: 23 KB, allocs: 1190: game/physics/Physics_RigidBody.cpp, line: 1164
    size: 22 KB, allocs: 369: game/ai/AAS_routing.cpp, line: 50
    size: 22 KB, allocs: 212: game/Game_local.cpp, line: 7116
    size: 20 KB, allocs: 39: renderer/RenderWorld_load.cpp, line: 623
    size: 19 KB, allocs: 60: game/AF.cpp, line: 826
    size: 18 KB, allocs: 30: framework/DeclAF.cpp, line: 1079
    size: 17 KB, allocs: 25: game/AFEntity.cpp, line: 1524
    size: 16 KB, allocs: 60: game/physics/Physics_AF.cpp, line: 1697
    size: 16 KB, allocs: 26: framework/DeclAF.cpp, line: 1157
    size: 15 KB, allocs: 397: c:/thedarkmod/tdm/idlib/containers/HashTable.h, line: 191
    size: 14 KB, allocs: 208: game/script/Script_Program.cpp, line: 2076
    size: 13 KB, allocs: 564: game/ai/EAS/EAS.cpp, line: 614
    size: 13 KB, allocs: 564: game/ai/EAS/EAS.cpp, line: 616
    size: 12 KB, allocs: 263: game/ai/AAS_routing.cpp, line: 894
    size: 12 KB, allocs: 3: framework/FileSystem.cpp, line: 1253
    size: 12 KB, allocs: 3: game/ai/AAS_routing.cpp, line: 238
    size: 12 KB, allocs: 13: ui/UserInterface.cpp, line: 270
    size: 11 KB, allocs: 86: game/Entity.cpp, line: 5868
    size: 11 KB, allocs: 60: framework/CVarSystem.cpp, line: 578
    size: 11 KB, allocs: 10: ui/Window.cpp, line: 2231
    size: 11 KB, allocs: 1: framework/KeyInput.cpp, line: 709
    size: 10 KB, allocs: 185: game/anim/Anim_Blend.cpp, line: 4637
    size: 10 KB, allocs: 684: ui/Window.cpp, line: 1694
    size: 10 KB, allocs: 649: renderer/tr_polytope.cpp, line: 91
    size: 9 KB, allocs: 133: game/StimResponse/Response.cpp, line: 212
    size: 9 KB, allocs: 615: ui/Window.cpp, line: 1628
    size: 9 KB, allocs: 68: game/Mover.cpp, line: 380
    size: 9 KB, allocs: 1158: game/PVSToAASMapping.cpp, line: 197
    size: 8 KB, allocs: 19: game/ai/AI.cpp, line: 1652
    size: 8 KB, allocs: 271: framework/CmdSystem.cpp, line: 371
    size: 8 KB, allocs: 53: renderer/ModelManager.cpp, line: 288
    size: 8 KB, allocs: 3: game/ai/AAS_routing.cpp, line: 218
    size: 8 KB, allocs: 173: ui/GuiScript.cpp, line: 450
    size: 7 KB, allocs: 1: game/Game_local.cpp, line: 585
    size: 6 KB, allocs: 12: game/ModelGenerator.cpp, line: 296
    size: 6 KB, allocs: 138: game/DarkModGlobals.cpp, line: 467
    size: 6 KB, allocs: 271: framework/CmdSystem.cpp, line: 366
    size: 6 KB, allocs: 3: game/ai/AAS_routing.cpp, line: 247
    size: 5 KB, allocs: 256: framework/DeclManager.cpp, line: 408
    size: 4 KB, allocs: 255: framework/DeclManager.cpp, line: 418
    size: 4 KB, allocs: 106: game/ai/AAS_routing.cpp, line: 1033
    size: 4 KB, allocs: 16: c:/thedarkmod/tdm/idlib/containers/List.h, line: 60
    size: 4 KB, allocs: 4: ui/Window.cpp, line: 2209
    size: 4 KB, allocs: 4: ui/EditWindow.cpp, line: 99
    size: 4 KB, allocs: 294: c:/thedarkmod/tdm/ui/Window.h, line: 110
    size: 4 KB, allocs: 141: game/anim/Anim_Blend.cpp, line: 343
    size: 4 KB, allocs: 72: game/anim/Anim_Blend.cpp, line: 4597
    size: 4 KB, allocs: 2: sound/snd_world.cpp, line: 81
    size: 3 KB, allocs: 21: idlib/math/Lcp.cpp, line: 1603
    size: 3 KB, allocs: 11: game/Player.cpp, line: 1325
    size: 3 KB, allocs: 14: game/Missions/MissionDB.cpp, line: 74
    size: 3 KB, allocs: 238: ui/Window.cpp, line: 1632
    size: 3 KB, allocs: 34: renderer/Model_md5.cpp, line: 743
    size: 3 KB, allocs: 105: ui/Window.cpp, line: 2305
    size: 3 KB, allocs: 30: game/SndProp.cpp, line: 332
    size: 3 KB, allocs: 294: ui/Window.cpp, line: 2335
    size: 3 KB, allocs: 25: game/AFEntity.cpp, line: 1481
    size: 3 KB, allocs: 271: framework/CmdSystem.cpp, line: 367
    size: 3 KB, allocs: 23: renderer/ModelManager.cpp, line: 294
    size: 3 KB, allocs: 3: framework/FileSystem.cpp, line: 1252
    size: 2 KB, allocs: 13: ui/UserInterface.cpp, line: 157
    size: 2 KB, allocs: 20: game/Entity.cpp, line: 5939
    size: 2 KB, allocs: 20: game/Actor.cpp, line: 2427
    size: 2 KB, allocs: 76: game/ai/EAS/EAS.cpp, line: 104
    size: 2 KB, allocs: 13: renderer/Cinematic.cpp, line: 57
    size: 2 KB, allocs: 19: game/ai/AI.cpp, line: 1986
    size: 2 KB, allocs: 19: game/AFEntity.cpp, line: 702
    size: 2 KB, allocs: 110: game/darkModLAS.cpp, line: 1282
    size: 2 KB, allocs: 4: framework/DeclAF.cpp, line: 961
    size: 2 KB, allocs: 19: game/ai/AI.cpp, line: 1655
    size: 2 KB, allocs: 3: game/ai/AAS_routing.cpp, line: 244
    size: 2 KB, allocs: 19: renderer/Model_prt.cpp, line: 95
    size: 1 KB, allocs: 30: game/SndProp.cpp, line: 384
    size: 1 KB, allocs: 14: game/Mover.cpp, line: 3391
    size: 1 KB, allocs: 8: game/physics/Physics_AF.cpp, line: 1872
    size: 1 KB, allocs: 1: ui/Window.cpp, line: 2286
    size: 1 KB, allocs: 105: c:/thedarkmod/tdm/ui/Window.h, line: 129
    size: 1 KB, allocs: 7: game/Inventory/Inventory.cpp, line: 656
    size: 1 KB, allocs: 1: game/SndProp.cpp, line: 366
    size: 1 KB, allocs: 20: game/StimResponse/Response.cpp, line: 189
    size: 1 KB, allocs: 3: tools/compilers/aas/AASFileManager.cpp, line: 50
    size: 1 KB, allocs: 1: ui/Window.cpp, line: 2264
    size: 1 KB, allocs: 4: game/physics/Physics_AF.cpp, line: 1084
    size: 1 KB, allocs: 81: game/darkModLAS.cpp, line: 1290
    size: 1 KB, allocs: 16: game/ai/States/IdleState.cpp, line: 174
    size: 1 KB, allocs: 1: game/SndProp.cpp, line: 314
    size: 1 KB, allocs: 5: game/physics/Physics_AF.cpp, line: 3102
    size: 1 KB, allocs: 1: cm/CollisionModel_load.cpp, line: 745
    size: 1 KB, allocs: 1: ui/ListWindow.cpp, line: 46
    size: 1 KB, allocs: 16: game/ai/Tasks/IdleAnimationTask.cpp, line: 437
    size: 1 KB, allocs: 4: game/AF.cpp, line: 748
    size: 1 KB, allocs: 8: game/Objectives/ObjectiveLocation.cpp, line: 72
    size: 1 KB, allocs: 14: game/Missions/MissionDB.cpp, line: 71
    size: 1 KB, allocs: 33: game/anim/Anim_Blend.cpp, line: 323
    size: 1 KB, allocs: 1: c:/thedarkmod/tdm/idlib/containers/HashTable.h, line: 86
    size: 0 KB, allocs: 1: game/SndProp.cpp, line: 319
    size: 0 KB, allocs: 39: game/SndPropLoader.cpp, line: 723
    size: 0 KB, allocs: 39: game/SndProp.cpp, line: 339
    size: 0 KB, allocs: 43: ui/Window.cpp, line: 2433
    size: 0 KB, allocs: 26: game/ai/Conversation/Conversation.cpp, line: 475
    size: 0 KB, allocs: 6: game/ai/AAS.cpp, line: 30
    size: 0 KB, allocs: 1: cm/CollisionModel_load.cpp, line: 742
    size: 0 KB, allocs: 24: game/anim/Anim_Blend.cpp, line: 702
    size: 0 KB, allocs: 19: game/ai/AI.cpp, line: 1656
    size: 0 KB, allocs: 19: game/ai/AI.cpp, line: 1657
    size: 0 KB, allocs: 19: game/ai/AI.cpp, line: 1658
    size: 0 KB, allocs: 19: game/ai/AI.cpp, line: 1659
    size: 0 KB, allocs: 23: game/anim/Anim_Blend.cpp, line: 826
    size: 0 KB, allocs: 23: game/anim/Anim_Blend.cpp, line: 724
    size: 0 KB, allocs: 3: framework/minizip/unzip.cpp, line: 792
    size: 0 KB, allocs: 42: renderer/RenderWorld_load.cpp, line: 295
    size: 0 KB, allocs: 42: idlib/geometry/Winding.cpp, line: 469
    size: 0 KB, allocs: 5: framework/CVarSystem.cpp, line: 151
    size: 0 KB, allocs: 2: sound/snd_system.cpp, line: 960
    size: 0 KB, allocs: 20: game/anim/Anim_Blend.cpp, line: 686
    size: 0 KB, allocs: 7: game/ai/Conversation/ConversationSystem.cpp, line: 242
    size: 0 KB, allocs: 14: game/SEED.cpp, line: 972
    size: 0 KB, allocs: 19: game/anim/Anim_Blend.cpp, line: 811
    size: 0 KB, allocs: 13: game/SEED.cpp, line: 3449
    size: 0 KB, allocs: 8: framework/DeclManager.cpp, line: 975
    size: 0 KB, allocs: 13: framework/DeclManager.cpp, line: 943
    size: 0 KB, allocs: 16: game/anim/Anim_Blend.cpp, line: 359
    size: 0 KB, allocs: 10: ui/Window.cpp, line: 2107
    size: 0 KB, allocs: 29: game/darkModLAS.cpp, line: 1299
    size: 0 KB, allocs: 14: game/anim/Anim_Blend.cpp, line: 834
    size: 0 KB, allocs: 14: game/anim/Anim_Blend.cpp, line: 849
    size: 0 KB, allocs: 7: game/Inventory/Inventory.cpp, line: 393
    size: 0 KB, allocs: 2: renderer/RenderSystem.cpp, line: 1067
    size: 0 KB, allocs: 6: game/ai/AAS.cpp, line: 48
    size: 0 KB, allocs: 21: game/physics/Physics_AF.cpp, line: 7366
    size: 0 KB, allocs: 16: game/ai/States/IdleState.cpp, line: 383
    size: 0 KB, allocs: 1: game/Pvs.cpp, line: 798
    size: 0 KB, allocs: 1: game/SndProp.cpp, line: 363
    size: 0 KB, allocs: 1: cm/CollisionModel_load.cpp, line: 682
    size: 0 KB, allocs: 9: game/anim/Anim_Blend.cpp, line: 605
    size: 0 KB, allocs: 2: game/IK.cpp, line: 539
    size: 0 KB, allocs: 8: game/anim/Anim_Blend.cpp, line: 504
    size: 0 KB, allocs: 3: game/ai/States/IdleSleepState.cpp, line: 106
    size: 0 KB, allocs: 1: game/Player.cpp, line: 1887
    size: 0 KB, allocs: 7: game/anim/Anim_Blend.cpp, line: 437
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 625
    size: 0 KB, allocs: 8: game/ai/MovementSubsystem.cpp, line: 423
    size: 0 KB, allocs: 16: game/ai/Tasks/RandomHeadturnTask.cpp, line: 138
    size: 0 KB, allocs: 8: renderer/draw_arb2.cpp, line: 841
    size: 0 KB, allocs: 2: framework/FileSystem.cpp, line: 2889
    size: 0 KB, allocs: 2: framework/FileSystem.cpp, line: 2756
    size: 0 KB, allocs: 8: c:/thedarkmod/tdm/idlib/math/Polynomial.h, line: 601
    size: 0 KB, allocs: 1: game/darkModLAS.cpp, line: 1209
    size: 0 KB, allocs: 1: game/Pvs.cpp, line: 793
    size: 0 KB, allocs: 1: game/PVSToAASMapping.cpp, line: 115
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 6588
    size: 0 KB, allocs: 3: game/ai/MovementSubsystem.cpp, line: 330
    size: 0 KB, allocs: 1: game/Entity.cpp, line: 5823
    size: 0 KB, allocs: 1: game/AFEntity.cpp, line: 1262
    size: 0 KB, allocs: 1: game/Player.cpp, line: 5738
    size: 0 KB, allocs: 1: game/Player.cpp, line: 8806
    size: 0 KB, allocs: 2: framework/FileSystem.cpp, line: 2053
    size: 0 KB, allocs: 16: game/Pvs.cpp, line: 809
    size: 0 KB, allocs: 4: game/anim/Anim_Blend.cpp, line: 566
    size: 0 KB, allocs: 8: game/ai/Memory.cpp, line: 446
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 607
    size: 0 KB, allocs: 1: game/ai/Tasks/HandleDoorTask.cpp, line: 2963
    size: 0 KB, allocs: 1: renderer/ModelManager.cpp, line: 206
    size: 0 KB, allocs: 1: renderer/ModelManager.cpp, line: 214
    size: 0 KB, allocs: 1: renderer/ModelManager.cpp, line: 220
    size: 0 KB, allocs: 1: renderer/ModelManager.cpp, line: 309
    size: 0 KB, allocs: 3: game/Inventory/Inventory.cpp, line: 904
    size: 0 KB, allocs: 2: framework/I18N.cpp, line: 428
    size: 0 KB, allocs: 3: game/anim/Anim_Blend.cpp, line: 754
    size: 0 KB, allocs: 3: game/anim/Anim_Blend.cpp, line: 734
    size: 0 KB, allocs: 1: ui/UserInterface.cpp, line: 210
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 1546
    size: 0 KB, allocs: 1: game/Objectives/MissionData.cpp, line: 1697
    size: 0 KB, allocs: 2: renderer/CinematicFFMpeg.cpp, line: 606
    size: 0 KB, allocs: 2: game/anim/Anim_Blend.cpp, line: 744
    size: 0 KB, allocs: 1: game/LightGem.cpp, line: 101
    size: 0 KB, allocs: 3: game/ai/States/IdleSleepState.cpp, line: 143
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 623
    size: 0 KB, allocs: 1: game/Entity.cpp, line: 10650
    size: 0 KB, allocs: 2: game/ai/MovementSubsystem.cpp, line: 348
    size: 0 KB, allocs: 1: renderer/RenderSystem_init.cpp, line: 2464
    size: 0 KB, allocs: 1: renderer/RenderSystem_init.cpp, line: 2467
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 591
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 611
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 615
    size: 0 KB, allocs: 3: game/EscapePointManager.cpp, line: 181
    size: 0 KB, allocs: 1: game/Pvs.cpp, line: 792
    size: 0 KB, allocs: 3: framework/FileSystem.cpp, line: 2079
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 589
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 619
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 1612
    size: 0 KB, allocs: 1: game/anim/Anim_Blend.cpp, line: 776
    size: 0 KB, allocs: 1: game/anim/Anim_Blend.cpp, line: 786
    size: 0 KB, allocs: 1: game/anim/Anim_Blend.cpp, line: 525
    size: 0 KB, allocs: 1: renderer/tr_main.cpp, line: 242
    size: 0 KB, allocs: 2: framework/FileSystem.cpp, line: 2052
    size: 0 KB, allocs: 1: sound/snd_system.cpp, line: 444
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 590
    size: 0 KB, allocs: 1: ui/Window.cpp, line: 2090
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 8065
    size: 0 KB, allocs: 1: game/Missions/MissionManager.cpp, line: 40
    size: 0 KB, allocs: 1: renderer/CinematicFFMpeg.cpp, line: 249
    size: 0 KB, allocs: 1: idlib/math/Simd.cpp, line: 43
    size: 0 KB, allocs: 1: idlib/math/Simd.cpp, line: 161
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 588
    size: 0 KB, allocs: 1: game/Game_local.cpp, line: 631
    338574 total memory blocks allocated
    486355 KB memory allocated
</details>

<h3 id="uninitialized-members"><a class="toclink" href="#uninitialized-members">Uninitialized members</a></h3>
<p>Leaving class members of primitive type uninitialized can cause annoying and non-reproducible bugs. That's why Visual C++ <a href="https://stackoverflow.com/a/370362/556899">fills allocated memory with magic values</a> like 0xCD or 0xCC in debug build, to increase the chances of program crashing due to such an error. For some reason, ID devs decided to implement their own version of this system for game objects.</p>
<p>In the game module of Doom 3, most of the classes inherit from <a href="https://github.com/id-Software/DOOM-3/blob/master/neo/game/gamesys/Class.h#L30">idClass</a> base, which allows to create object instance by type name and supports events for scripting system. All objects in this hierarchy are manually filled with 0xCD because <em>idClass</em> overloads <em>operator new</em> and <em>operator delete</em>:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="o">*</span> <span class="n">idClass</span><span class="o">::</span><span class="k">operator</span> <span class="k">new</span><span class="p">(</span> <span class="kt">size_t</span> <span class="n">s</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="n">s</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="kt">int</span> <span class="p">);</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">Mem_Alloc</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
    <span class="n">memused</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
    <span class="n">numobjects</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef ID_DEBUG_UNINITIALIZED_MEMORY</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xcdcdcdcd</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">return</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Now the remaining question is: <u>where are the messages about uninitialized class members coming from?</u></p>
<p>Quick search by the text of message gives the following bits of code:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define CLASS_DECLARATION( nameofsuperclass, nameofclass ) \</span>
<span class="cp">    </span><span class="c1">//...some more ...                                     \</span>
    <span class="n">idClass</span> <span class="o">*</span><span class="nf">nameofclass::CreateInstance</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span> <span class="p">{</span>         \
        <span class="k">try</span> <span class="p">{</span>                                              \
            <span class="n">nameofclass</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">nameofclass</span><span class="p">;</span>            \
            <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">FindUninitializedMemory</span><span class="p">();</span>                \
            <span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>                                    \
        <span class="p">}</span>                                                  \
        <span class="k">catch</span><span class="p">(</span> <span class="n">idAllocError</span> <span class="o">&amp;</span> <span class="p">)</span> <span class="p">{</span>                          \
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>                                   \
        <span class="p">}</span>                                                  \
    <span class="p">}</span>                                                      \

<span class="kt">void</span> <span class="nf">idClass::FindUninitializedMemory</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ID_DEBUG_UNINITIALIZED_MEMORY</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span> <span class="p">)</span><span class="k">this</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xcdcdcdcd</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">varName</span> <span class="o">=</span> <span class="n">GetTypeVariableName</span><span class="p">(</span> <span class="n">GetClassname</span><span class="p">(),</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="p">);</span>
            <span class="n">gameLocal</span><span class="p">.</span><span class="n">Warning</span><span class="p">(</span>
                <span class="s">&quot;type &#39;%s&#39; has uninitialized variable %s (offset %d)&quot;</span><span class="p">,</span>
                <span class="n">GetClassname</span><span class="p">(),</span> <span class="n">varName</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>
</code></pre></div>

<p>The method <em>CreateInstance</em> (wrapped into macro CLASS_DECLARATION) allows creating game objects by type, and it is always called when a game object is created. As you see, it calls <em>FindUninitializedMemory</em> method after creation, which checks which words still have values 0xCDCDCDCD, and reports them. The only thing remaining is the <em>GetTypeVariableName</em> function, and this is where the truly dark magic is.</p>
<h3 id="typeinfo"><a class="toclink" href="#typeinfo">TypeInfo</a></h3>
<p>In order to obtain name of the class member from its offset, information about all the member offsets must be embedded into the code. Currently, C++ compilers do not do that (although there are <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0194r3.html">proposals</a> for something like that). Standard C++ RTTI only stores class name and inheritance hierarchy for polymorphic types, it does not store any info about members. There are <a href="http://www.garret.ru/cppreflection/docs/reflect.html">several approaches</a> for implementing reflection in C++. Preprocessor can generate the necessary information, given that you use macros for declaring members (<a href="http://pfultz2.com/blog/2012/07/31/reflection-in-under-100-lines/">example</a>), or specialized parser can generate the necessary information (e.g. <a href="http://doc.qt.io/qt-4.8/moc.html">Qt MOC</a>). Doom 3 uses the latter way: homebrew parser does that.</p>
<p>Recall that Doom 3 uses its own <a href="https://www.iddevnet.com/doom3/script.php">C++-like scripting language</a>, which is parsed, compiled and interpreted by custom code (see <a href="http://fabiensanglard.net/doom3/scripting_vm.php">review</a>). The lexer and parser are reused for several different tasks. The parser also performs all the job of C preprocessor: it #includes files, checks #if-s and #ifdef-s, manages #define-s and performs macro substitution. This same parser is reused in the specialized <a href="https://github.com/id-Software/DOOM-3/tree/master/neo/TypeInfo">TypeInfo compiler</a>, whose only purpose is to generate a header with all the desired type information. It parses a single cpp file of the game module, which is supposed to include headers with all the declarations. So: <strong>ID's script parser is good enough to parse Doom 3 game sources</strong> and extract data from them! Well, it has its own issues (no pragma once support, some C++11 syntax not supported), but this is a remarkable achievement nonetheless.</p>
<p>After having parsed everything, TypeInfo compiler generates a header <em>GameTypeInfo.h</em> in <em>game/gamesys/</em>. This header contains the following information (you can <a href="https://yadi.sk/i/o5ZCUfnE3L5rP3">download</a> resulting GameTypeInfo.h for TDM):</p>
<ol>
    <li><strong>constants</strong>: type, name, value (including enum values and static const members);</li>
    <li><strong>enums</strong>: list of all enums, list of name/value pairs for all enums;</li>
    <li><strong>class members</strong>: type, name, offset, size;</li>
    <li><strong>classes</strong>: full list, name, base class name, pointer to members list;</li>
</ol>

<p>Here is an example of information for members of <em>idStr</em> class:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="n">classVariableInfo_t</span> <span class="n">idStr_typeInfo</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="s">&quot;len&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">idStr</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span> <span class="p">((</span><span class="n">idStr</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="p">)</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;char *&quot;</span><span class="p">,</span> <span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">idStr</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span> <span class="p">((</span><span class="n">idStr</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span> <span class="p">)</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="s">&quot;alloced&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">idStr</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">alloced</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span> <span class="p">((</span><span class="n">idStr</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">alloced</span> <span class="p">)</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;char[20]&quot;</span><span class="p">,</span> <span class="s">&quot;baseBuffer&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">idStr</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">baseBuffer</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span> <span class="p">((</span><span class="n">idStr</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">baseBuffer</span> <span class="p">)</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>Clearly, it contains enough information to make it possible to get member name from offset. Note that sizes and offsets are written as C++ expressions evaluated to proper values, instead of plain integer constants. This allows to avoid messing with struct alignment rules of Visual C++ compiler. However, it also requires to do an ugly hack (called "Public Morozov" in Russia) to make sure that private and protected members are accessible in <a href="https://github.com/id-Software/DOOM-3/blob/master/neo/game/gamesys/TypeInfo.cpp">TypeInfo.cpp</a>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// This is real evil but allows the code</span>
<span class="c1">// to inspect arbitrary class variables.</span>
<span class="cp">#define private     public</span>
<span class="cp">#define protected   public</span>
</code></pre></div>

<p>Here is the full diagram for building TypeInfo in memory debugging configuration (for the case of TDM):</p>
<p><img src="https://dirtyhandscoding.github.io/images/0_doom3_typeinfo/typeinfo_scheme1.png" class="centered w500" /></p>
<h3 id="saving-game-state"><a class="toclink" href="#saving-game-state">Saving game state</a></h3>
<p>Is it worth to implement the whole TypeInfo thing just for printing the name of an uninitialized member? I think not. But this is not the only thing which relies on TypeInfo. Another thing made possible by TypeInfo is printing the whole game state in a readable text format. Normally, all the savegame data is stored in binary format, because it is much faster to do so and the resulting file is smaller (although I <a href="http://forums.thedarkmod.com/topic/12060-compressing-savegame-file/">added compression</a> on top of it in TDM). But text representation may be very useful for debugging issues (e.g. forgot to save/restore some member), maybe even maintaining backwards compatibility of savegame files.</p>
<p>The code is located in the same TypeInfo.cpp file. It contains several methods which traverse all the game objects and do something with them. All of them rely on the methods <a href="https://github.com/id-Software/DOOM-3/blob/master/neo/game/gamesys/TypeInfo.cpp#L1149">idTypeInfoTools::WriteClass_r</a> and  <a href="https://github.com/id-Software/DOOM-3/blob/master/neo/game/gamesys/TypeInfo.cpp#L524">idTypeInfoTools::WriteVariable_r</a>, which implement the traversal itself. The latter method is responsible for interpreting every possible type of class member; for instance it contains special code which supports traversing all elements of <em>idList </em>container (which is ID's equivalent to <em>std::vector</em>):</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">idTypeInfoTools::WriteVariable_r</span><span class="p">(</span>
    <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">varPtr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">varName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">varType</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scope</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pointerDepth</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="c1">//...(more code)...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">token</span> <span class="o">==</span> <span class="s">&quot;idList&quot;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">idList</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="p">((</span><span class="n">idList</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="n">varPtr</span><span class="p">);</span>
        <span class="n">Write</span><span class="p">(</span><span class="n">varName</span><span class="p">,</span> <span class="n">varType</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="s">&quot;.num&quot;</span><span class="p">,</span> <span class="n">va</span><span class="p">(</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">Num</span><span class="p">()</span> <span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">Write</span><span class="p">(</span><span class="n">varName</span><span class="p">,</span> <span class="n">varType</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="s">&quot;.granularity&quot;</span><span class="p">,</span> <span class="n">va</span><span class="p">(</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">GetGranularity</span><span class="p">()</span> <span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">Num</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ParseTemplateArguments</span><span class="p">(</span> <span class="n">typeSrc</span><span class="p">,</span> <span class="n">templateArgs</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kt">void</span> <span class="o">*</span><span class="n">listVarPtr</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">Ptr</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">Num</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">idStr</span> <span class="n">listVarName</span> <span class="o">=</span> <span class="n">va</span><span class="p">(</span> <span class="s">&quot;%s[%d]&quot;</span><span class="p">,</span> <span class="n">varName</span><span class="p">,</span> <span class="n">i</span> <span class="p">);</span>
                <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">WriteVariable_r</span><span class="p">(</span><span class="n">listVarPtr</span><span class="p">,</span> <span class="n">listVarName</span><span class="p">,</span> <span class="n">templateArgs</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">pointerDepth</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">-1</span> <span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="n">listVarPtr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span> <span class="p">(</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">listVarPtr</span> <span class="p">)</span> <span class="o">+</span> <span class="n">size</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">typeSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">idList</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">token</span> <span class="o">==</span> <span class="s">&quot;idStaticList&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">//...(more code)...</span>
<span class="p">}</span>
</code></pre></div>

<p>During traversal, method <em>Write</em> is called, as you can see on lines 5 and 8 of the last listing. This is actually not a method, but a function pointer, which is initialized differently depending on the current needs. This method accepts seven parameters:</p>
<div class="highlight"><pre><span></span><code><span class="n">varType</span> <span class="o">|</span> <span class="n">prefix</span> <span class="o">|</span> <span class="n">scope</span> <span class="o">|</span> <span class="n">varName</span> <span class="o">|</span> <span class="n">postfix</span> <span class="o">|</span> <span class="n">value</span> <span class="o">|</span> <span class="n">varSize</span>
<span class="o">====================================================================================================</span>
<span class="s">&quot;float&quot;</span> <span class="o">|</span> <span class="s">&quot;&quot;</span> <span class="o">|</span> <span class="s">&quot;idEntity&quot;</span> <span class="o">|</span> <span class="s">&quot;m_MinLODBias&quot;</span> <span class="o">|</span> <span class="s">&quot;&quot;</span> <span class="o">|</span> <span class="s">&quot;0&quot;</span> <span class="o">|</span> <span class="mi">4</span>
<span class="s">&quot;idBounds&quot;</span> <span class="o">|</span> <span class="s">&quot;idEntity::renderEntity.&quot;</span> <span class="o">|</span> <span class="s">&quot;renderEntity_t&quot;</span> <span class="o">|</span> <span class="s">&quot;bounds&quot;</span> <span class="o">|</span> <span class="s">&quot;&quot;</span> <span class="o">|</span> <span class="s">&quot;(-6.75103283 -2.63098955 -20)-(7 2.5482502 49.51835632)&quot;</span> <span class="o">|</span> <span class="mi">24</span>
<span class="s">&quot;idDict&quot;</span> <span class="o">|</span> <span class="s">&quot;&quot;</span> <span class="o">|</span> <span class="s">&quot;idEntity&quot;</span> <span class="o">|</span> <span class="s">&quot;spawnArgs&quot;</span> <span class="o">|</span> <span class="s">&quot;[7]&quot;</span> <span class="o">|</span> <span class="s">&quot;&#39;noclipmodel&#39;  &#39;0&#39;&quot;</span> <span class="o">|</span> <span class="mi">0</span>
<span class="s">&quot;idEntity::entityFlags_s&quot;</span> <span class="o">|</span> <span class="s">&quot;&quot;</span> <span class="o">|</span> <span class="s">&quot;idEntity&quot;</span> <span class="o">|</span> <span class="s">&quot;fl&quot;</span> <span class="o">|</span> <span class="s">&quot;.invisible&quot;</span> <span class="o">|</span> <span class="s">&quot;false&quot;</span> <span class="o">|</span> <span class="mi">0</span>
<span class="s">&quot;idList &lt; idEntityPtr &lt; idActor &gt; &gt;&quot;</span> <span class="o">|</span> <span class="s">&quot;idEntity::m_userManager.&quot;</span> <span class="o">|</span> <span class="s">&quot;UserManager&quot;</span> <span class="o">|</span> <span class="s">&quot;m_users&quot;</span> <span class="o">|</span> <span class="s">&quot;.num&quot;</span> <span class="o">|</span> <span class="s">&quot;0&quot;</span> <span class="o">|</span> <span class="mi">0</span>
</code></pre></div>

<p>In this text, first line specifies order of seven parameters, and each of the next lines shows one example of their values, seven values per line, splitted with vertical dash. The first example corresponds to member <em>idEntity::m_MinLODBias</em> of <em>float</em> type, having zero value. The second one corresponds to member <em>renderEntity_s::bounds</em> of type <em>idBounds</em> (coordinates of two vertices are given), where <em>renderEntity_s</em> itself is a member <em>idEntity::renderEntity</em>. The third one shows 7-th entry of <em>idEntity::spawnArgs</em> dictionary (<em>idDict</em>) as 'key'-'value' pair. The forth example is a boolean value <em>entityFlags_s::invisible</em> in bitset structure <em>idEntity::fl</em>. The last one corresponds to number of elements in <em>UserManager::m_Users</em>, which has type <em>idList</em> (aggregated in <em>idEntity::m_userManager</em>).</p>
<p>Now let's return back to Doom 3 and game state saving. Whenever you save game in memory debugging configuration, a file named like "Quicksave_1_save.gameState.txt" is created near the ordinary savegame file. This is a text file of size about 40MB, where each member of each game entity is fully described. The full version of this file can be <a href="https://yadi.sk/i/vnU0gkPR3L5rbd">downloaded</a>, and here is a small excerpt from it:</p>
<div class="highlight"><pre><span></span><code><span class="n">entity</span> <span class="mi">36</span> <span class="n">idStaticEntity</span> <span class="p">{</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">entityNumber</span> <span class="o">=</span> <span class="s">&quot;36&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">entityDefNumber</span> <span class="o">=</span> <span class="s">&quot;28&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">spawnNode</span> <span class="o">=</span> <span class="s">&quot;&lt;unknown type &#39;idLinkList &lt; idEntity &gt;&#39;&gt;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">activeNode</span> <span class="o">=</span> <span class="s">&quot;&lt;unknown type &#39;idLinkList &lt; idEntity &gt;&#39;&gt;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">snapshotNode</span> <span class="o">=</span> <span class="s">&quot;&lt;unknown type &#39;idLinkList &lt; idEntity &gt;&#39;&gt;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">snapshotSequence</span> <span class="o">=</span> <span class="s">&quot;-1&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">snapshotBits</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;func_static_5&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">spawnArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&#39;classname&#39;  &#39;func_static&#39;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">spawnArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&#39;name&#39;  &#39;func_static_5&#39;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">spawnArgs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&#39;model&#39;  &#39;models/darkmod/furniture/seating/chair_simple01.lwo&#39;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">spawnArgs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&#39;origin&#39;  &#39;216.743 -47.89 20&#39;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">spawnArgs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&#39;rotation&#39;  &#39;0.707107 -0.707107 0 0.707107 0.707107 0 0 0 1&#39;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">spawnArgs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&#39;inline&#39;  &#39;0&#39;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">spawnArgs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&#39;spawnclass&#39;  &#39;idStaticEntity&#39;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">spawnArgs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&#39;solid&#39;  &#39;1&#39;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">spawnArgs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&#39;noclipmodel&#39;  &#39;0&#39;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">scriptObject</span><span class="p">.</span><span class="n">idScriptObject</span><span class="o">::</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;&lt;pointer type &#39;idTypeDef *&#39; not listed&gt;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">scriptObject</span><span class="p">.</span><span class="n">idScriptObject</span><span class="o">::</span><span class="n">data</span> <span class="o">=</span> <span class="s">&quot;&lt;NULL&gt;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">thinkFlags</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">dormantStart</span> <span class="o">=</span> <span class="s">&quot;-2920&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">cinematic</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">cameraTarget</span> <span class="o">=</span> <span class="s">&quot;&lt;NULL&gt;&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">targets</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">targets</span><span class="p">.</span><span class="n">granularity</span> <span class="o">=</span> <span class="s">&quot;16&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">health</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">maxHealth</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">fl</span><span class="p">.</span><span class="n">notarget</span> <span class="o">=</span> <span class="s">&quot;false&quot;</span>
<span class="n">idEntity</span><span class="o">::</span><span class="n">fl</span><span class="p">.</span><span class="n">noknockback</span> <span class="o">=</span> <span class="s">&quot;false&quot;</span>
</code></pre></div>

<p>Whenever you restore game from a save in this configuration, full game state after loading is saved into file "Quicksave_1_restore.gameState.txt". Moreover, this restored state is compared field-by-field with the old one (which was written on save) using the same game state traversal code, and messages about mismatches (i.e. state diffs) are printed to the game console:</p>
<p><img src="https://dirtyhandscoding.github.io/images/0_doom3_typeinfo/savegamecompare.png" class="w700" /></p>
<h3 id="conclusion"><a class="toclink" href="#conclusion">Conclusion</a></h3>
<p>So all of this was about a tiny little part of Doom 3 source code: memory debugging and typeinfo processing. It is worth noting that typeinfo stuff was completely removed by ID from Doom3 BFG (it is missing in the sources). Most likely this is because of the maintenance burden it causes. You can read more about the issues caused by all this hackery in the corresponding <a href="http://wiki.thedarkmod.com/index.php?title=TypeInfo_and_Memory_debugging_configuration">TDM wiki article</a>.</p>
<p>Speaking of TDM, now we have to understand how much value this system has. The first moves would be to fix all the issues detected currently, and to add support for some new data structures (include STL stuff). The TypeInfo system would either give some benefit or be removed, and it is not clear yet which path would be taken.</p>
      
    </div><!-- /.entry-content -->
    <section>
        <div id="post-share-links" class="inline-menu">
            <div>Share on:</div>
            <a href="https://twitter.com/intent/tweet?text=Doom%203%3A%20C%2B%2B%20enhanced%20RTTI%20and%20memory%20debugging&url=https%3A//dirtyhandscoding.github.io/posts/doom-3-c-enhanced-rtti-and-memory-debugging.html" target="_blank" class="icon-label" title="Share on Twitter">Twitter</a><!--
            --><a href="http://www.facebook.com/sharer/sharer.php?u=https%3A//dirtyhandscoding.github.io/posts/doom-3-c-enhanced-rtti-and-memory-debugging.html" target="_blank" class="icon-label" title="Share on Facebook">Facebook</a><!--
            --><a href="https://plus.google.com/share?url=https%3A//dirtyhandscoding.github.io/posts/doom-3-c-enhanced-rtti-and-memory-debugging.html" target="_blank" class="icon-label" title="Share on Google Plus">Google+</a><!--
            --><a href="https://sharetodiaspora.github.io/?title=Doom%203%3A%20C%2B%2B%20enhanced%20RTTI%20and%20memory%20debugging&url=https%3A//dirtyhandscoding.github.io/posts/doom-3-c-enhanced-rtti-and-memory-debugging.html" target="_blank" class="icon-label" title="Share on Diaspora">Diaspora*</a><!--
            --><a href="https://news.ycombinator.com/submitlink?t=Doom%203%3A%20C%2B%2B%20enhanced%20RTTI%20and%20memory%20debugging&u=https%3A//dirtyhandscoding.github.io/posts/doom-3-c-enhanced-rtti-and-memory-debugging.html" target="_blank" class="icon-label" title="Share on HackerNews">HackerNews</a><!--
            --><a href="mailto:?subject=Doom%203%3A%20C%2B%2B%20enhanced%20RTTI%20and%20memory%20debugging&amp;body=https%3A//dirtyhandscoding.github.io/posts/doom-3-c-enhanced-rtti-and-memory-debugging.html" target="_blank" class="icon-label" title="Share via Email">Email</a>
        </div>
    </section>
    
    			<!--<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>-->
		<script src="https://dirtyhandscoding.github.io/theme/js/jquery.min.js"></script>
	<script type="text/javascript" src="https://dirtyhandscoding.github.io/theme/pelican_comment_system/comments.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			CommentSystem.email_user   = "itiswrongemail";
			CommentSystem.email_domain = "outlook.com";

			$('#pcs-comment-form').on("submit",
				function( event )
				{
					event.preventDefault();
					$(location).attr('href', CommentSystem.getMailtoLink("doom-3-c-enhanced-rtti-and-memory-debugging"));
				}
			);
		});
	</script>

    	<section>
	<div id="pcs-comments-header" class="inline-menu">
	<header>
		<div>Comments (0)</div>
		<button type="button" title="Expand or collapse the comments section" class="icon-label" id="pcs-comments-collapse-button" onclick="CommentSystem.collapsible($('#pcs-comments'), $(this));">
			<span class="nocss">expand</span>
		</button>
			<a href="https://dirtyhandscoding.github.io/feeds/comment.doom-3-c-enhanced-rtti-and-memory-debugging.atom.xml" class="icon-label">atom feed: comments</a>
	</header>
	</div>
	<div id="pcs-comments">
		<p>There are no comments yet.</p>
	<section>
	<div display="none" id="pcs-comment-notreply-helper" />
	<form id="pcs-comment-form" action="#">
		<fieldset>
		<legend>Add a Comment</legend>
		<div id="pcs-comment-tab-inputs">
			<input type="hidden" id="pcs-comment-form-input-replyto"/>
			<label for="pcs-comment-form-input-name">Name</label>
			<input  id="pcs-comment-form-input-name" type="text" size="40" placeholder="Enter your name or nickname" />
			<br/>
			<label for="pcs-comment-form-input-website">Website</label>
			<input  id="pcs-comment-form-input-website" type="text" size="40" placeholder="Enter your website (optional)" />
			<br/>
			<label for="pcs-comment-form-input-empty">Empty</label>
			<input  id="pcs-comment-form-input-empty" type="text" size="30" placeholder="Do NOT enter anything here!" />
			<label   for="pcs-comment-form-input-textarea">Your Comment</label>
			<br/>
			<textarea id="pcs-comment-form-input-textarea" rows="7" cols="40" placeholder="Enter your comment (markdown is allowed)"></textarea>
		</div>
		<div id="pcs-comment-tab-message" style="display:none">
			<textarea readonly rows="10" cols="40"></textarea>
		</div>

		<button type="submit"
				id="pcs-comment-form-button-submit"
				title="Create mailto link and open it in default email client &#10;Note: you have to send the email to post comment"
				>Post via email</button>
		<button type="button"
				id="pcs-comment-form-button-message"
				title="See the text of email message to be sent &#10;Note: you can copy it and send manually"
				onclick="CommentSystem.viewEmail(&quot;doom-3-c-enhanced-rtti-and-memory-debugging&quot;);"
				>View email text</button>
		<a target="_blank"
				id="pcs-comment-gmail-config-help"
				title="How to configure Chrome to open mailto links in Gmail..."
				href="https://productforums.google.com/forum/#!topic/gmail/JtWVPbUfh-o"
				>?</a>
		</fieldset>

		<!--			<a href="https://dirtyhandscoding.github.io/feeds/comment.doom-3-c-enhanced-rtti-and-memory-debugging.atom.xml">
				Comment Atom Feed
			</a>
-->
	</form>
	<script>CommentSystem.displayReplyTo();</script>
</section>

	</div>
	<script>
		$('#pcs-comments').css({display: "none"});
		$('#pcs-comments-collapse-button').addClass('collapsed');
	</script>
</section>

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            <li><a href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">rss feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, customized to personal taste.</p>
        </footer><!-- /#contentinfo -->

</body>
</html>