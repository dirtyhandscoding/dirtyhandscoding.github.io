<!DOCTYPE html>
<html lang="en">
<head>
        <!-- load favicon from /images -->
        <link rel="icon" type="image/png" href="/images/favicon.png" />
        <!-- stgatilov: properly detect device width on a mobile -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/> 

        <meta charset="utf-8" />
        <title>Improvements to SymbolSort tool for C++ code bloat analysis</title>
        <link rel="stylesheet" href="https://dirtyhandscoding.github.io/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Dirty hands coding Atom Feed" />
        <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Dirty hands coding RSS Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://dirtyhandscoding.github.io/">Dirty hands coding </a></h1>
                <nav><ul>
                    <li><a href="/archives.html">ARCHIVES</a></li>
                    <li><a href="/categories.html">CATEGORIES</a></li>
                    <li><a href="/tags.html">TAGS</a></li>
                    <li><a href="/pages/contact.html">CONTACT</a></li>
                </ul>
<form class="navbar-search" action="https://dirtyhandscoding.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);">
                        <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input">
                    </form>
                </nav>
<div id="submenu">
                    <ul>
                            <li><a href="https://dirtyhandscoding.github.io/category/high-performance.html">High performance</a></li>
                            <li><a href="https://dirtyhandscoding.github.io/category/the-dark-mod.html">The Dark Mod</a></li>
                            <li class="active"><a href="https://dirtyhandscoding.github.io/category/uncategorized.html">Uncategorized</a></li>
                    </ul>
                <div>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://dirtyhandscoding.github.io/posts/improvements-to-symbolsort-tool-for-c-code-bloat-analysis.html" rel="bookmark"
           title="Permalink to Improvements to SymbolSort tool for C++ code bloat analysis">Improvements to SymbolSort tool for C++ code bloat analysis</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>27 May 2018</span>
	        <span>| in <a href="https://dirtyhandscoding.github.io/category/uncategorized.html">Uncategorized</a></span>
<span>| tags: <a href="https://dirtyhandscoding.github.io/tag/cpp.html">cpp</a><a href="https://dirtyhandscoding.github.io/tag/bloat.html">bloat</a><a href="https://dirtyhandscoding.github.io/tag/build.html">build</a><a href="https://dirtyhandscoding.github.io/tag/msvc.html">msvc</a></span>
</footer><!-- /.post-info -->      
      <p>It is known that code bloat <a href="https://dirtyhandscoding.github.io/posts/on-cpp-code-bloat.html">significantly increases build times in C++</a>. The question is: how can we quantify code bloat? How can we see things which are compiled too many times or the things which generate too much object code? How can we know which places would benefit most from improvement efforts?</p>
<p>This article is about an excellent tool called <a href="https://github.com/adrianstone55/SymbolSort">SymbolSort</a>, which produces useful code bloat statistics in a project of any size. In particular, the article describes a few improvements which I have implemented recently to provide more useful analysis.</p>


<h2 id="manual"><a class="toclink" href="#manual">Manual</a></h2>
<p>The simplest approach to see what exactly is compiled is to enable generation of assembly listings (<a href="https://msdn.microsoft.com/en-us/library/367y26c6.aspx">/FA or /FAs on MSVC</a>) and look through them from time to time. In case of MSVC, all generated symbols are listed at the top of the .asm file as <code>PUBLIC</code> symbols, e.g.:</p>
<div class="highlight"><pre><span></span><span class="p">;</span> <span class="n">Listing</span> <span class="n">generated</span> <span class="n">by</span> <span class="nf">Microsoft</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Optimizing</span> <span class="n">Compiler</span> <span class="n">Version</span> <span class="mf">18.00.40629.0</span>

<span class="n">include</span> <span class="n">listing</span><span class="p">.</span><span class="n">inc</span>

<span class="n">INCLUDELIB</span> <span class="n">LIBCMT</span>
<span class="n">INCLUDELIB</span> <span class="n">OLDNAMES</span>

<span class="n">PUBLIC</span>  <span class="n">hypot</span>
<span class="n">PUBLIC</span>  <span class="n">main</span>
<span class="n">PUBLIC</span>  <span class="o">??</span><span class="err">$</span><span class="n">calcSum</span><span class="err">@</span><span class="n">H</span><span class="err">@@</span><span class="n">YAHPEBHH</span><span class="err">@</span><span class="n">Z</span>                                            <span class="p">;</span> <span class="n">calcSum</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>
<span class="n">PUBLIC</span>  <span class="o">?</span><span class="n">run</span><span class="err">@</span><span class="o">?</span><span class="err">$</span><span class="n">Bar</span><span class="err">@</span><span class="n">H</span><span class="err">$</span><span class="mo">06</span><span class="err">@@</span><span class="n">QEBAHXZ</span>                                            <span class="p">;</span> <span class="n">Bar</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="mi">7</span><span class="o">&gt;::</span><span class="n">run</span>
<span class="n">PUBLIC</span>  <span class="o">??</span><span class="err">$</span><span class="n">accumulate</span><span class="err">@</span><span class="n">PEBHH</span><span class="err">@</span><span class="n">std</span><span class="err">@@</span><span class="n">YAHPEBH0H</span><span class="err">@</span><span class="n">Z</span>                                <span class="p">;</span> <span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="o">*</span> <span class="n">__ptr64</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;</span>
<span class="n">PUBLIC</span>  <span class="o">??</span><span class="err">$</span><span class="n">accumulate</span><span class="err">@</span><span class="n">PEBHHU</span><span class="o">?</span><span class="err">$</span><span class="n">plus</span><span class="err">@</span><span class="n">X</span><span class="err">@</span><span class="n">std</span><span class="err">@@@</span><span class="n">std</span><span class="err">@@</span><span class="n">YAHPEBH0HU</span><span class="o">?</span><span class="err">$</span><span class="n">plus</span><span class="err">@</span><span class="n">X</span><span class="err">@</span><span class="mi">0</span><span class="err">@@</span><span class="n">Z</span>     <span class="p">;</span> <span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="o">*</span> <span class="n">__ptr64</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">plus</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="o">&gt;</span>
<span class="n">PUBLIC</span>  <span class="o">??</span><span class="err">$</span><span class="n">_Unchecked</span><span class="err">@</span><span class="n">PEBH</span><span class="err">@</span><span class="n">std</span><span class="err">@@</span><span class="n">YAPEBHPEBH</span><span class="err">@</span><span class="n">Z</span>                                <span class="p">;</span> <span class="n">std</span><span class="o">::</span><span class="n">_Unchecked</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="o">*</span> <span class="n">__ptr64</span><span class="o">&gt;</span>
<span class="n">PUBLIC</span>  <span class="o">??</span><span class="err">$</span><span class="n">_Accumulate</span><span class="err">@</span><span class="n">PEBHHU</span><span class="o">?</span><span class="err">$</span><span class="n">plus</span><span class="err">@</span><span class="n">X</span><span class="err">@</span><span class="n">std</span><span class="err">@@@</span><span class="n">std</span><span class="err">@@</span><span class="n">YAHPEBH0HU</span><span class="o">?</span><span class="err">$</span><span class="n">plus</span><span class="err">@</span><span class="n">X</span><span class="err">@</span><span class="mi">0</span><span class="err">@@</span><span class="n">Z</span>    <span class="p">;</span> <span class="n">std</span><span class="o">::</span><span class="n">_Accumulate</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="o">*</span> <span class="n">__ptr64</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">plus</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="o">&gt;</span>
<span class="n">PUBLIC</span>  <span class="o">??</span><span class="err">$</span><span class="o">?</span><span class="n">RAEAHAEBH</span><span class="err">@</span><span class="o">?</span><span class="err">$</span><span class="n">plus</span><span class="err">@</span><span class="n">X</span><span class="err">@</span><span class="n">std</span><span class="err">@@</span><span class="n">QEBA</span><span class="o">?</span><span class="n">BHAEAHAEBH</span><span class="err">@</span><span class="n">Z</span>                       <span class="p">;</span> <span class="n">std</span><span class="o">::</span><span class="n">plus</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;::</span><span class="k">operator</span><span class="p">()</span><span class="o">&lt;</span><span class="kt">int</span> <span class="o">&amp;</span> <span class="n">__ptr64</span><span class="p">,</span><span class="kt">int</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">__ptr64</span><span class="o">&gt;</span>
<span class="n">PUBLIC</span>  <span class="o">??</span><span class="n">_C</span><span class="err">@</span><span class="n">_03PMGGPEJJ</span><span class="err">@</span><span class="o">?</span><span class="err">$</span><span class="n">CFd</span><span class="o">?</span><span class="mi">6</span><span class="o">?</span><span class="err">$</span><span class="n">AA</span><span class="err">@</span>                                       <span class="p">;</span> <span class="err">`</span><span class="n">string</span><span class="err">&#39;</span>
<span class="n">PUBLIC</span>  <span class="n">__xmm</span><span class="err">@</span><span class="mo">00000004000000030000000200000001</span>
<span class="n">EXTRN</span>   <span class="nl">printf</span><span class="p">:</span><span class="n">PROC</span>
<span class="n">EXTRN</span>   <span class="nl">_hypot</span><span class="p">:</span><span class="n">PROC</span>
<span class="n">EXTRN</span>   <span class="nl">__GSHandlerCheck</span><span class="p">:</span><span class="n">PROC</span>
<span class="n">EXTRN</span>   <span class="nl">__security_check_cookie</span><span class="p">:</span><span class="n">PROC</span>
<span class="n">EXTRN</span>   <span class="nl">__security_cookie</span><span class="p">:</span><span class="n">QWORD</span>
<span class="n">EXTRN</span>   <span class="nl">_fltused</span><span class="p">:</span><span class="n">DWORD</span>
<span class="p">...</span>
</pre></div>


<p>It is especially insightful to take a small .cpp file which has suspiciously large .obj file and look into the assembly generated.
In the simplest case, it is enough to look through function symbols, although there is a lot of other stuff: constants of various types and exception handlers. Also note that <code>EXTRN</code> symbols are <strong>not</strong> generated in this file.</p>
<p>Anyway, this approach does not provide statistics over the whole project. It can help to gain understanding of what happens, but it requires a good guess to actually notice a problem. And without changing the code there is no way to see how big the problem is.</p>
<h2 id="symbolsort"><a class="toclink" href="#symbolsort">SymbolSort</a></h2>
<p>SymbolSort is a tool created by Adrian Stone, originally <a href="http://gameangst.com/?p=320">announced in his blog</a> and later <a href="https://github.com/adrianstone55/SymbolSort">released for public on GitHub</a>. It is recommended to read the original blog article for detailed description of its options and results.
In general, the tool parses a set of input files, extracts information about all symbols contained in them, and then prints out various types of statistics.</p>
<p>SymbolSort supports two major types of input files:</p>
<ol>
<li>
<p>A dump of object file (or files), produced either by <a href="https://docs.microsoft.com/en-us/cpp/build/reference/dumpbin-reference">dumpbin.exe</a> (Visual C++) or by <a href="https://en.wikipedia.org/wiki/Nm_(Unix)">nm</a> (GNU binutils). This type of input is most useful for analyzing build times, since it counts symbols before linker deduplicates them. In the current article, only MSVC platform will be considered.</p>
</li>
<li>
<p>A module (either executable or dynamic library) or a .pdb file with debug symbols. As far as I understand, analyzing an .exe file is equivalent to analyzing its .pdb file. Since this is the final binary with all the symbols deduplicated, this type of analysis is most useful for reducing executable size and improving code cache performance, but not for improving build performance.</p>
</li>
</ol>
<p>To demonstrate SymbolSort capabilities, I'll apply it to some real-world C++ project. I'll try to analyze <a href="http://www.thedarkmod.com/main/">The Dark Mod</a> (TDM), which is an open source standalone game based on Doom 3 engine. It is very important to note that the Doom 3 engine originally does <strong>not</strong> use STL at all: it has its own library called "idLib" with greatly simplified custom alternatives to STL stuff. However, the dark mod coders used STL in many places over their code, so we will definitely see it in the analysis too.</p>
<h2 id="demo-exe"><a class="toclink" href="#demo-exe">Demo: exe</a></h2>
<p>First let's run SymbolSort on the final TDM executable:</p>
<div class="highlight"><pre><span></span>SymbolSort -in TheDarkModx64.exe -out TheDarkModx64.exe.report
</pre></div>


<p>After a few seconds, we can see the result in <code>TheDarkModx64.exe.report</code> (the full file is much longer):</p>
<div class="highlight"><pre><span></span><span class="n">Raw</span> <span class="n">Symbols</span>
<span class="n">Total</span> <span class="n">Count</span>  <span class="p">:</span> <span class="mi">64112</span>
<span class="n">Total</span> <span class="n">Size</span>   <span class="p">:</span> <span class="mi">60215952</span>
<span class="n">Unattributed</span> <span class="p">:</span> <span class="mi">2750964</span>
<span class="o">--------------------------------------</span>
<span class="n">Sorted</span> <span class="n">by</span> <span class="n">Size</span>
        <span class="n">Size</span> <span class="n">Section</span><span class="o">/</span><span class="n">Type</span>  <span class="n">Name</span>                     <span class="n">Source</span>
    <span class="mi">16777216</span>          <span class="n">bss</span>  <span class="n">optEdges</span>                 <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">tools</span><span class="o">\</span><span class="n">compilers</span><span class="o">\</span><span class="n">dmap</span><span class="o">\</span><span class="n">optimize</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">7834688</span>          <span class="n">bss</span>  <span class="n">sessLocal</span>                <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">framework</span><span class="o">\</span><span class="n">session</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">6887456</span>          <span class="n">bss</span>  <span class="n">gameLocal</span>                <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">game</span><span class="o">\</span><span class="n">game_local</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">6291456</span>          <span class="n">bss</span>  <span class="n">optVerts</span>                 <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">tools</span><span class="o">\</span><span class="n">compilers</span><span class="o">\</span><span class="n">dmap</span><span class="o">\</span><span class="n">optimize</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">3407872</span>          <span class="n">bss</span>  <span class="n">outputTris</span>               <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">tools</span><span class="o">\</span><span class="n">compilers</span><span class="o">\</span><span class="n">dmap</span><span class="o">\</span><span class="n">shadowopt3</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">2359296</span>          <span class="n">bss</span>  <span class="n">silQuads</span>                 <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">tools</span><span class="o">\</span><span class="n">compilers</span><span class="o">\</span><span class="n">dmap</span><span class="o">\</span><span class="n">shadowopt3</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">1572864</span>          <span class="n">bss</span>  <span class="n">shadowVerts</span>              <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">renderer</span><span class="o">\</span><span class="n">tr_stencilshadow</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">1572864</span>          <span class="n">bss</span>  <span class="n">silEdges</span>                 <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">tools</span><span class="o">\</span><span class="n">compilers</span><span class="o">\</span><span class="n">dmap</span><span class="o">\</span><span class="n">shadowopt3</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">786432</span>          <span class="n">bss</span>  <span class="n">rb_debugLines</span>            <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">renderer</span><span class="o">\</span><span class="n">tr_rendertools</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">589824</span>          <span class="n">bss</span>  <span class="n">EventPool</span>                <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">game</span><span class="o">\</span><span class="n">gamesys</span><span class="o">\</span><span class="n">event</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">576360</span>         <span class="n">data</span>  <span class="n">localConsole</span>             <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">framework</span><span class="o">\</span><span class="n">console</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">524288</span>          <span class="n">bss</span>  <span class="n">udpPorts</span>                 <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">sys</span><span class="o">\</span><span class="n">win32</span><span class="o">\</span><span class="n">win_net</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">458752</span>          <span class="n">bss</span>  <span class="n">rb_debugPolygons</span>         <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">renderer</span><span class="o">\</span><span class="n">tr_rendertools</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">393216</span>          <span class="n">bss</span>  <span class="n">shadowIndexes</span>            <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">renderer</span><span class="o">\</span><span class="n">tr_stencilshadow</span><span class="o">.</span><span class="n">cpp</span>
    <span class="o">...</span>             <span class="o">...</span>  <span class="o">...</span>                      <span class="o">...</span>
</pre></div>


<p>Note that the file <code>TheDarkModx64.exe</code> is only 10 MB, and here it says that there are 60 MB of symbols. Moreover, the largest symbols are attributed to <a href="https://en.wikipedia.org/wiki/.bss">.bss</a> section, meaning that they are global or static variables. It seems that IdTech4 loves global variables too much. In order to workaround this problem, we can use the newly added <code>-sections</code> parameter to filter only code symbols:</p>
<div class="highlight"><pre><span></span>SymbolSort -in TheDarkModx64.exe -out TheDarkModx64.exe.report -sections code
</pre></div>


<p>This gives us much more useful statistics, which includes only the machine code.
The SymbolSort produces many different lists of symbols (or groups of symbols), sorted by total count, size or name. You can <a href="https://dirtyhandscoding.github.io/code/7_symbolsort/TheDarkModx64.exe.report">download this complete report</a> and look into it yourself. Here I will pay close attention only to two lists.</p>
<p>The first is the list of file contributions, which shows how much code or symbols are generated for each source code file, also with information about directories:</p>
<div class="highlight"><pre><span></span><span class="n">File</span> <span class="n">Contributions</span>
<span class="o">--------------------------------------</span>
<span class="n">Sorted</span> <span class="n">by</span> <span class="n">Size</span>
        <span class="n">Size</span>   <span class="n">Count</span>  <span class="n">Source</span> <span class="n">Path</span>
    <span class="mi">6028867</span>   <span class="mi">33730</span>  <span class="n">c</span><span class="p">:</span>
    <span class="mi">5869935</span>   <span class="mi">31632</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>
<span class="hll">    <span class="mi">2957843</span>   <span class="mi">16774</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">game</span>
</span><span class="hll">    <span class="mi">1194434</span>    <span class="mi">7034</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">tools</span>
</span>    <span class="mi">631682</span>    <span class="mi">3243</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">game</span>\<span class="n">ai</span>
    <span class="mi">581988</span>    <span class="mi">3156</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">tools</span>\<span class="n">radiant</span>
    <span class="mi">541960</span>    <span class="mi">2149</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">idlib</span>
    <span class="mi">509794</span>    <span class="mi">1878</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">renderer</span>
    <span class="mi">338432</span>    <span class="mi">1156</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">game</span>\<span class="n">physics</span>
    <span class="mi">280497</span>    <span class="mi">1768</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">framework</span>
    <span class="mi">249891</span>     <span class="mi">458</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">idlib</span>\<span class="n">math</span>
    <span class="mi">230854</span>     <span class="mi">665</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">tools</span>\<span class="n">compilers</span>
    <span class="mi">172726</span>     <span class="mi">499</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">game</span>\<span class="n">ai</span>\<span class="n">ai</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">168365</span>    <span class="mi">1477</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">game</span>\<span class="n">gamesys</span>
    <span class="mi">163355</span>     <span class="mi">814</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">game</span>\<span class="n">ai</span>\<span class="n">states</span>
<span class="hll">    <span class="mi">158932</span>    <span class="mi">2098</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span>\<span class="n">microsoft</span> <span class="n">visual</span> <span class="n">studio</span> <span class="mf">12.0</span>\<span class="n">vc</span>
</span>    <span class="mi">156801</span>    <span class="mi">2002</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span>\<span class="n">microsoft</span> <span class="n">visual</span> <span class="n">studio</span> <span class="mf">12.0</span>\<span class="n">vc</span>\<span class="n">include</span>
    <span class="mi">153308</span>    <span class="mi">1057</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">game</span>\<span class="n">entity</span><span class="o">.</span><span class="n">cpp</span>
    <span class="mi">138646</span>     <span class="mi">933</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">thedarkmod</span>\<span class="n">darkmod_src</span>\<span class="n">ui</span>
    <span class="o">...</span>        <span class="o">...</span>  <span class="o">...</span>
<span class="hll">    <span class="mi">76322</span>     <span class="mi">506</span>  <span class="n">c</span><span class="p">:</span>\<span class="n">program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span>\<span class="n">microsoft</span> <span class="n">visual</span> <span class="n">studio</span> <span class="mf">12.0</span>\<span class="n">vc</span>\<span class="n">include</span>\<span class="n">xtree</span>
</span>    <span class="o">...</span>        <span class="o">...</span>  <span class="o">...</span>
</pre></div>


<p>As you see, it is easy to learn how much code space is taken by each game subsystem. The whole code is 6 MB. The game logic itself (<code>darkmod_src\game</code>) occupies half of code space (3 MB), while various tools (<code>darkmod_src\tools</code>) take only about 20% (1.2 MB). Also, this view makes it most convenient to see how much code is generated for MSVC standard library: only 160 KB is taken by noninlined functions of standard library, with almost half of it (75KB) generated by <code>xtree</code> header. This header contains implementation of <code>std::set</code> and <code>std::map</code>, which often constitutes most of the machine code from STL.</p>
<p>Another useful statistics shows how much space is taken by all instances of a template function or method. Here it is (sorted by size):</p>
<div class="highlight"><pre><span></span><span class="n">Merged</span> <span class="n">Template</span> <span class="n">Symbols</span>
<span class="n">Merged</span> <span class="n">Count</span>  <span class="p">:</span> <span class="mi">26353</span>
<span class="o">--------------------------------------</span>
<span class="n">Sorted</span> <span class="n">by</span> <span class="n">Total</span> <span class="n">Count</span>
    <span class="o">...</span>

<span class="n">Sorted</span> <span class="n">by</span> <span class="n">Total</span> <span class="n">Size</span>
  <span class="n">Total</span> <span class="n">Size</span>  <span class="n">Total</span> <span class="n">Count</span>  <span class="n">Name</span>
      <span class="mi">5027</span>         <span class="mi">2160</span>  <span class="err">`</span><span class="n">dynamic</span> <span class="n">initializer</span> <span class="k">for</span> <span class="s1">&#39;...&#39;&#39;</span>
      <span class="mi">2032</span>         <span class="mi">2030</span>  <span class="err">`</span><span class="n">dynamic</span> <span class="n">atexit</span> <span class="n">destructor</span> <span class="k">for</span> <span class="s1">&#39;...&#39;&#39;</span>
<span class="hll">      <span class="mi">6417</span>          <span class="mi">220</span>  <span class="n">public</span><span class="p">:</span> <span class="n">void</span> <span class="n">__cdecl</span> <span class="n">idList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">Resize</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="n">__ptr64</span>
</span>      <span class="mi">5410</span>           <span class="mi">67</span>  <span class="n">ai</span><span class="p">::</span><span class="err">`</span><span class="n">dynamic</span> <span class="n">initializer</span> <span class="k">for</span> <span class="s1">&#39;...&#39;&#39;</span>
<span class="hll">      <span class="mi">2087</span>           <span class="mi">17</span>  <span class="n">protected</span><span class="p">:</span> <span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Insert_at</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">__ptr64</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span> <span class="n">__ptr64</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Nil</span><span class="p">)</span> <span class="n">__ptr64</span>
</span><span class="hll">      <span class="mi">1261</span>           <span class="mi">26</span>  <span class="n">public</span><span class="p">:</span> <span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">erase</span><span class="p">(</span><span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">__ptr64</span>
</span>      <span class="mi">8678</span>           <span class="mi">16</span>  <span class="n">public</span><span class="p">:</span> <span class="k">class</span> <span class="nc">A0xa82155d7</span><span class="p">::</span><span class="n">xpath_ast_node</span> <span class="o">*</span> <span class="n">__ptr64</span> <span class="n">__cdecl</span> <span class="err">`</span><span class="n">anonymous</span> <span class="n">namespace</span><span class="s1">&#39;</span>
<span class="hll">      <span class="mi">8577</span>           <span class="mi">13</span>  <span class="n">protected</span><span class="p">:</span> <span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Insert_hint</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">__ptr64</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">__ptr64</span><span class="p">)</span> <span class="n">__ptr64</span>
</span><span class="hll">      <span class="mi">7112</span>           <span class="mi">18</span>  <span class="n">protected</span><span class="p">:</span> <span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Insert_nohint</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span> <span class="n">__ptr64</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Nil</span><span class="p">)</span> <span class="n">__ptr64</span>
</span>      <span class="mi">6563</span>           <span class="mi">19</span>  <span class="n">void</span> <span class="n">__cdecl</span> <span class="err">`</span><span class="n">anonymous</span> <span class="n">namespace</span><span class="s1">&#39;</span>
      <span class="mi">6286</span>           <span class="mi">12</span>  <span class="n">private</span><span class="p">:</span> <span class="k">class</span> <span class="nc">A0xa82155d7</span><span class="p">::</span><span class="n">xpath_node_set_raw</span> <span class="n">__cdecl</span> <span class="err">`</span><span class="n">anonymous</span> <span class="n">namespace</span><span class="s1">&#39;</span>
      <span class="mi">5662</span>          <span class="mi">140</span>  <span class="err">`</span><span class="n">std</span><span class="p">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Resetp</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="s1">&#39;...&#39;</span><span class="p">::</span><span class="n">catch</span><span class="err">$</span><span class="mi">0</span>
<span class="hll">      <span class="mi">5504</span>           <span class="mi">13</span>  <span class="n">protected</span><span class="p">:</span> <span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Insert_nohint</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">__ptr64</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">__ptr64</span><span class="p">)</span> <span class="n">__ptr64</span>
</span>      <span class="mi">5338</span>            <span class="mi">4</span>  <span class="n">private</span><span class="p">:</span> <span class="n">static</span> <span class="nb">bool</span> <span class="n">__cdecl</span> <span class="err">`</span><span class="n">anonymous</span> <span class="n">namespace</span><span class="s1">&#39;</span>
<span class="hll">      <span class="mi">4883</span>           <span class="mi">13</span>  <span class="n">protected</span><span class="p">:</span> <span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Insert_at</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">__ptr64</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">__ptr64</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">__ptr64</span><span class="p">)</span> <span class="n">__ptr64</span>
</span>      <span class="o">...</span>           <span class="o">...</span>  <span class="o">...</span>
</pre></div>


<p>Let's leave the problem of dynamic initializers and destructors --- those are most likely initialization code for global and static variables, and idTech4 has a lot of them. The first highlighted line shows that <code>idList&lt;T&gt;::Resize</code> method has 220 instances of total size 6.4 KB. The other highlighted lines show various methods of <code>std::_Tree</code> template (which is the implementation of <code>std::set</code> and <code>std::map</code>). Information like this is especially useful for generic template classes, which are used a lot in the project.</p>
<p>One question which easily comes to mind is: "how much code is generated for the whole <code>std::_Tree</code> class"? The stock version of SymbolSort cannot answer this question.</p>
<h2 id="demo-obj"><a class="toclink" href="#demo-obj">Demo: obj</a></h2>
<p>As mentioned before, the analysis of executable may be useful for optimizing instruction caching, but it does not represent well where the build time is spent. Every function defined in header is compiled independently as many times as there are source files using it (read more <a href="https://dirtyhandscoding.github.io/posts/on-cpp-code-bloat.html#headers">here</a>), with duplicates being merged by linker later. Writing code in headers may be necessary for inlining, and also for templates. And even though idTech4 was written long time ago by people <a href="https://kotaku.com/454293019">mainly proficient with C</a>, it still contains some templates.</p>
<p>To better estimate build time, we should analyze .obj files instead of executable. Every .obj file represents all the code generated by compiler for the corresponding translation unit, so if we sum up the stats across all .obj files, we will know how much code was compiled (including duplicates). And it is probably better to do so for debug build with inlining disabled, because even though inlined functions can be omitted in .obj files, they still take compiler's time.</p>
<p>In order to run SymbolSort on .obj files, we have to 1) run <code>dumpbin.exe /headers</code> on every .obj file and 2) list all the resulting symbol files as arguments to SymbolSort. It is also allowed concatenate all symbol files into one file <code>all_obj.smb</code>. Here is an example:</p>
<div class="highlight"><pre><span></span>SymbolSort -in:comdat .\DarkModTools\all_obj.smb -in:comdat .\idLib\all_obj.smb -out object_files.report
</pre></div>


<p>To simplify invoking SymbolSort, I have created <a href="https://gist.github.com/stgatilov/8368456c533a20ee13b8075857d1768f">bloatinfo.py</a> script. In order to get single report over several projects, just run the following command in the directory containing their .obj files:</p>
<div class="highlight"><pre><span></span>bloatinfo --obj=. --dump --analyze
</pre></div>


<p>The script calls <code>dumpbin</code> internally, merges symbol files for each project and runs SymbolSort on them. The results are put into <code>object_files.report</code> in the current directory (you can <a href="https://dirtyhandscoding.github.io/code/7_symbolsort/object_files.report">download the full report</a>):</p>
<div class="highlight"><pre><span></span><span class="n">Raw</span> <span class="n">Symbols</span>
<span class="n">Total</span> <span class="nl">Count</span>  <span class="p">:</span> <span class="mi">126533</span>
<span class="n">Total</span> <span class="nl">Size</span>   <span class="p">:</span> <span class="mi">21001307</span>
<span class="nl">Unattributed</span> <span class="p">:</span> <span class="mi">0</span>
<span class="o">--------------------------------------</span>
<span class="n">Sorted</span> <span class="n">by</span> <span class="n">Size</span>
        <span class="n">Size</span> <span class="n">Section</span><span class="o">/</span><span class="n">Type</span>  <span class="n">Name</span>                                                                                                                      <span class="n">Source</span>
    <span class="mi">106356</span>     <span class="p">.</span><span class="n">text</span><span class="err">$</span><span class="n">mn</span>  <span class="k">public</span><span class="o">:</span> <span class="kt">bool</span> <span class="kr">__cdecl</span> <span class="n">idClass</span><span class="o">::</span><span class="n">ProcessEventArgPtr</span><span class="p">(</span><span class="k">class</span> <span class="nc">idEventDef</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span><span class="kr">__int64</span> <span class="o">*</span><span class="p">)</span>                                      <span class="p">.</span><span class="err">\</span><span class="n">DarkModTools</span><span class="err">\</span><span class="n">Class</span><span class="p">.</span><span class="n">obj</span>
    <span class="mi">65536</span>         <span class="p">.</span><span class="n">bss</span>  <span class="kt">char</span> <span class="p">(</span><span class="o">*</span> <span class="err">`</span><span class="kt">char</span> <span class="o">*</span> <span class="kr">__cdecl</span> <span class="n">va</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="p">,...)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">2</span><span class="err">&#39;</span><span class="o">::</span><span class="n">string</span><span class="p">)[</span><span class="mi">16384</span><span class="p">]</span>                                                        <span class="p">.</span><span class="err">\</span><span class="n">idLib</span><span class="err">\</span><span class="n">Str</span><span class="p">.</span><span class="n">obj</span>
    <span class="mi">65536</span>         <span class="p">.</span><span class="n">bss</span>  <span class="kt">char</span> <span class="p">(</span><span class="o">*</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="k">static</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="kr">__cdecl</span> <span class="n">idStr</span><span class="o">::</span><span class="n">FloatArrayToString</span><span class="p">(</span><span class="kt">float</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="kt">int</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">2</span><span class="err">&#39;</span><span class="o">::</span><span class="n">str</span><span class="p">)[</span><span class="mi">16384</span><span class="p">]</span>          <span class="p">.</span><span class="err">\</span><span class="n">idLib</span><span class="err">\</span><span class="n">Str</span><span class="p">.</span><span class="n">obj</span>
    <span class="mi">65536</span>         <span class="p">.</span><span class="n">bss</span>  <span class="kt">char</span> <span class="p">(</span><span class="o">*</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="k">static</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="kr">__cdecl</span> <span class="n">idTypeInfoTools</span><span class="o">::</span><span class="n">OutputString</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">2</span><span class="err">&#39;</span><span class="o">::</span><span class="n">buffers</span><span class="p">)[</span><span class="mi">16384</span><span class="p">]</span>           <span class="p">.</span><span class="err">\</span><span class="n">DarkModTools</span><span class="err">\</span><span class="n">TypeInfo</span><span class="p">.</span><span class="n">obj</span>
    <span class="mi">65536</span>         <span class="p">.</span><span class="n">bss</span>  <span class="k">class</span> <span class="nc">idClipModel</span> <span class="o">*</span> <span class="o">*</span> <span class="err">`</span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="n">GetObstacles</span><span class="p">(</span><span class="k">class</span> <span class="nc">idPhysics</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span><span class="k">class</span> <span class="nc">idAAS</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span><span class="k">class</span> <span class="nc">idEntity</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="k">class</span> <span class="nc">idVec3</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">class</span> <span class="nc">idVec3</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">struct</span> <span class="n">obstacle_s</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="k">class</span> <span class="nc">idBounds</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">struct</span> <span class="n">obstaclePath_s</span> <span class="o">&amp;</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">5</span><span class="err">&#39;</span><span class="o">::</span><span class="n">clipModelList</span>  <span class="p">.</span><span class="err">\</span><span class="n">DarkModTools</span><span class="err">\</span><span class="n">AI_pathing</span><span class="p">.</span><span class="n">obj</span>
    <span class="mi">65536</span>         <span class="p">.</span><span class="n">bss</span>  <span class="k">class</span> <span class="nc">idEntity</span> <span class="o">*</span> <span class="o">*</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="kt">float</span> <span class="kr">__cdecl</span> <span class="n">idPush</span><span class="o">::</span><span class="n">ClipRotationalPush</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_s</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">class</span> <span class="nc">idEntity</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="k">class</span> <span class="nc">idMat3</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">class</span> <span class="nc">idRotation</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">2</span><span class="err">&#39;</span><span class="o">::</span><span class="n">entityList</span>  <span class="p">.</span><span class="err">\</span><span class="n">DarkModTools</span><span class="err">\</span><span class="n">Push</span><span class="p">.</span><span class="n">obj</span>
    <span class="mi">65536</span>         <span class="p">.</span><span class="n">bss</span>  <span class="k">class</span> <span class="nc">idEntity</span> <span class="o">*</span> <span class="o">*</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="kt">void</span> <span class="kr">__cdecl</span> <span class="n">idPlayer</span><span class="o">::</span><span class="n">PerformFrobCheck</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">42</span><span class="err">&#39;</span><span class="o">::</span><span class="n">frobRangeEnts</span>                           <span class="p">.</span><span class="err">\</span><span class="n">DarkModTools</span><span class="err">\</span><span class="n">Player</span><span class="p">.</span><span class="n">obj</span>
    <span class="mi">64768</span>         <span class="p">.</span><span class="n">bss</span>  <span class="k">struct</span> <span class="n">polyhedron</span> <span class="o">*</span> <span class="err">`</span><span class="k">struct</span> <span class="n">polyhedron</span> <span class="kr">__cdecl</span> <span class="n">make_sv</span><span class="p">(</span><span class="k">struct</span> <span class="n">polyhedron</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">class</span> <span class="nc">idVec4</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">2</span><span class="err">&#39;</span><span class="o">::</span><span class="n">lut</span>                 <span class="p">.</span><span class="err">\</span><span class="n">DarkModTools</span><span class="err">\</span><span class="n">tr_shadowbounds</span><span class="p">.</span><span class="n">obj</span>
    <span class="mi">62651</span>     <span class="p">.</span><span class="n">text</span><span class="err">$</span><span class="n">mn</span>  <span class="k">public</span><span class="o">:</span> <span class="kt">bool</span> <span class="kr">__cdecl</span> <span class="n">idMat6</span><span class="o">::</span><span class="n">InverseSelf</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>                                                                            <span class="p">.</span><span class="err">\</span><span class="n">idLib</span><span class="err">\</span><span class="n">Matrix</span><span class="p">.</span><span class="n">obj</span>
    <span class="p">...</span>            <span class="p">...</span>  <span class="p">...</span>
</pre></div>


<p>As usual, there are many .bss symbols here. The total size by sections is:</p>
<div class="highlight"><pre><span></span><span class="n">Merged</span> <span class="n">Sections</span> <span class="o">/</span> <span class="n">Types</span>
<span class="n">Merged</span> <span class="n">Count</span>  <span class="p">:</span> <span class="mi">10</span>
<span class="o">--------------------------------------</span>
<span class="n">Sorted</span> <span class="n">by</span> <span class="n">Total</span> <span class="n">Count</span>
<span class="n">Total</span> <span class="n">Size</span>  <span class="n">Total</span> <span class="n">Count</span>  <span class="n">Name</span>
    <span class="mi">15530261</span>        <span class="mi">84799</span>  <span class="o">.</span><span class="n">text</span><span class="err">$</span><span class="n">mn</span>
     <span class="mi">2288278</span>        <span class="mi">15786</span>  <span class="o">.</span><span class="n">rdata</span>
      <span class="mi">780809</span>         <span class="mi">9632</span>  <span class="o">.</span><span class="n">text</span><span class="err">$</span><span class="n">x</span>
      <span class="mi">211188</span>         <span class="mi">7545</span>  <span class="o">.</span><span class="n">rdata</span><span class="err">$</span><span class="n">r</span>
      <span class="mi">321431</span>         <span class="mi">2609</span>  <span class="o">.</span><span class="n">text</span><span class="err">$</span><span class="n">di</span>
      <span class="mi">104892</span>         <span class="mi">2289</span>  <span class="o">.</span><span class="n">data</span><span class="err">$</span><span class="n">r</span>
       <span class="mi">86136</span>         <span class="mi">2206</span>  <span class="o">.</span><span class="n">text</span><span class="err">$</span><span class="n">yd</span>
<span class="hll">     <span class="mi">1629712</span>         <span class="mi">1258</span>  <span class="o">.</span><span class="n">bss</span>
</span>       <span class="mi">48392</span>          <span class="mi">383</span>  <span class="o">.</span><span class="n">data</span>
         <span class="mi">208</span>           <span class="mi">26</span>  <span class="o">.</span><span class="n">CRT</span><span class="err">$</span><span class="n">XCU</span>
</pre></div>


<p>As you see, there are only 1.5 MB of such symbols, not 50 MB as we saw in the executable. I have no idea why the other global variables are not shown here.</p>
<p>Anyway, we have 15.5 MB of machine code compiled in total over all object files, contrasted with 11.5 MB of code in <code>TheDarkModx64.exe</code> when built in Debug configuration. This gives us nice 4/3 ratio of overcompilation, which is very good. On my initial run I even got a ratio less than one, which happened because <a href="https://docs.microsoft.com/en-us/cpp/build/reference/gy-enable-function-level-linking">function-level linking</a> was not enabled, so some symbols were missing in dumpbin outputs. A rule of thumb is: <strong>enable function-level linking for .obj analysis</strong>, otherwise non-template non-inline stuff will be missing in the report!</p>
<p>I think such low overcompilation ratio was only possible due to the <a href="http://fabiensanglard.net/doom3_bfg/index.php">"C with classes" mindset</a>. Modern C++ programming with templates abuse is much worse in this regard. For instance, <a href="https://github.com/KhronosGroup/OpenCOLLADA/tree/master/COLLADASaxFrameworkLoader">one project of OpenCollada</a> has 9/2 ratio of overcompilation. It means that each piece of code has to be independently compiled 4.5 times on average. Actually, most of this bloat in object files comes from a few templates, which have crazy ratio of overcompilation (near hundred).</p>
<p>But let's continue with TheDarkMod. The "file contributions" section in the <code>object_files.report</code> is not revealing:</p>
<div class="highlight"><pre><span></span><span class="n">File</span> <span class="n">Contributions</span>
<span class="o">--------------------------------------</span>
<span class="n">Sorted</span> <span class="n">by</span> <span class="n">Size</span>
        <span class="n">Size</span>   <span class="n">Count</span>  <span class="n">Source</span> <span class="n">Path</span>
    <span class="mi">20976534</span>  <span class="mi">126384</span>  <span class="o">.</span>
    <span class="mi">19193802</span>  <span class="mi">120624</span>  <span class="o">.\</span><span class="n">DarkModTools</span>
     <span class="mi">1782732</span>    <span class="mi">5760</span>  <span class="o">.\</span><span class="n">idLib</span>
      <span class="mi">477915</span>    <span class="mi">2320</span>  <span class="o">.\</span><span class="n">DarkModTools</span><span class="o">\</span><span class="n">AI</span><span class="o">.</span><span class="n">obj</span>
      <span class="mi">439014</span>    <span class="mi">1926</span>  <span class="o">.\</span><span class="n">DarkModTools</span><span class="o">\</span><span class="n">Player</span><span class="o">.</span><span class="n">obj</span>
      <span class="mi">432376</span>    <span class="mi">2643</span>  <span class="o">.\</span><span class="n">DarkModTools</span><span class="o">\</span><span class="n">Entity</span><span class="o">.</span><span class="n">obj</span>
      <span class="mi">333805</span>    <span class="mi">2241</span>  <span class="o">.\</span><span class="n">DarkModTools</span><span class="o">\</span><span class="n">Game_local</span><span class="o">.</span><span class="n">obj</span>
      <span class="mi">318057</span>     <span class="mi">399</span>  <span class="o">.\</span><span class="n">idLib</span><span class="o">\</span><span class="n">Matrix</span><span class="o">.</span><span class="n">obj</span>
      <span class="mi">254341</span>    <span class="mi">1203</span>  <span class="o">.\</span><span class="n">DarkModTools</span><span class="o">\</span><span class="n">pugixml</span><span class="o">.</span><span class="n">obj</span>
      <span class="mi">238372</span>    <span class="mi">1041</span>  <span class="o">.\</span><span class="n">DarkModTools</span><span class="o">\</span><span class="n">Physics_AF</span><span class="o">.</span><span class="n">obj</span>
      <span class="mi">189301</span>     <span class="mi">510</span>  <span class="o">.\</span><span class="n">DarkModTools</span><span class="o">\</span><span class="n">EditorBrush</span><span class="o">.</span><span class="n">obj</span>
      <span class="mi">184638</span>     <span class="mi">886</span>  <span class="o">.\</span><span class="n">DarkModTools</span><span class="o">\</span><span class="n">MainFrm</span><span class="o">.</span><span class="n">obj</span>
      <span class="mi">174207</span>    <span class="mi">1138</span>  <span class="o">.\</span><span class="n">DarkModTools</span><span class="o">\</span><span class="n">Actor</span><span class="o">.</span><span class="n">obj</span>
      <span class="mi">163010</span>     <span class="mi">641</span>  <span class="o">.\</span><span class="n">DarkModTools</span><span class="o">\</span><span class="n">Window</span><span class="o">.</span><span class="n">obj</span>
      <span class="o">...</span>        <span class="o">...</span>  <span class="o">...</span>
</pre></div>


<p>Here machine code is classified into object files. If some class like <code>idList</code> generates much bloat because its methods are defined in header, we won't see it here. Because every .obj file will have at most one duplicate of each of these methods. It turns out that the most nasty code bloaters are evenly spread across .obj files, making this "file contributions" section useless.</p>
<p>A better view is provided by "merged template symbols" section:</p>
<div class="highlight"><pre><span></span><span class="n">Merged</span> <span class="n">Template</span> <span class="n">Symbols</span>
<span class="n">Merged</span> <span class="n">Count</span>  <span class="p">:</span> <span class="mi">39841</span>
<span class="o">--------------------------------------</span>

<span class="n">Sorted</span> <span class="n">by</span> <span class="n">Total</span> <span class="n">Size</span>
  <span class="n">Total</span> <span class="n">Size</span>  <span class="n">Total</span> <span class="n">Count</span>  <span class="n">Name</span>
      <span class="mi">865280</span>          <span class="mi">104</span>  <span class="n">protected</span><span class="p">:</span> <span class="n">static</span> <span class="n">struct</span> <span class="n">ATL</span><span class="p">::</span><span class="n">CTrace</span><span class="p">::</span><span class="n">CategoryMap</span> <span class="o">*</span> <span class="n">ATL</span><span class="p">::</span><span class="n">CTrace</span><span class="p">::</span><span class="n">m_nMap</span>
      <span class="mi">482057</span>         <span class="mi">6611</span>  <span class="err">`</span><span class="n">string</span><span class="s1">&#39;</span>
      <span class="mi">297459</span>         <span class="mi">2299</span>  <span class="n">void</span> <span class="n">__cdecl</span> <span class="err">`</span><span class="n">dynamic</span> <span class="n">initializer</span> <span class="k">for</span> <span class="s1">&#39;...&#39;&#39;</span>
<span class="hll">      <span class="mi">243853</span>          <span class="mi">107</span>  <span class="n">public</span><span class="p">:</span> <span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">erase</span><span class="p">(</span><span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span>
</span>      <span class="mi">207875</span>          <span class="mi">523</span>  <span class="n">public</span><span class="p">:</span> <span class="n">void</span> <span class="n">__cdecl</span> <span class="n">idList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">Resize</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="hll">      <span class="mi">139609</span>           <span class="mi">83</span>  <span class="n">protected</span><span class="p">:</span> <span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Insert_nohint</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Nil</span><span class="p">)</span>
</span><span class="hll">      <span class="mi">124320</span>           <span class="mi">21</span>  <span class="n">protected</span><span class="p">:</span> <span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Insert_hint</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span>
</span><span class="hll">       <span class="mi">91184</span>           <span class="mi">82</span>  <span class="n">protected</span><span class="p">:</span> <span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Insert_at</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="p">,</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Nil</span><span class="p">)</span>
</span>       <span class="mi">80271</span>          <span class="mi">679</span>  <span class="n">public</span><span class="p">:</span> <span class="n">void</span> <span class="n">__cdecl</span> <span class="n">idList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">Clear</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
       <span class="mi">79856</span>         <span class="mi">2045</span>  <span class="n">void</span> <span class="n">__cdecl</span> <span class="err">`</span><span class="n">dynamic</span> <span class="n">atexit</span> <span class="n">destructor</span> <span class="k">for</span> <span class="s1">&#39;...&#39;&#39;</span>
<span class="hll">       <span class="mi">70246</span>          <span class="mi">103</span>  <span class="n">public</span><span class="p">:</span> <span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">erase</span><span class="p">(</span><span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span>
</span>       <span class="mi">59325</span>          <span class="mi">525</span>  <span class="n">public</span><span class="p">:</span> <span class="n">__cdecl</span> <span class="n">idList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">idList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="mi">50102</span>           <span class="mi">94</span>  <span class="n">public</span><span class="p">:</span> <span class="n">void</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Copy</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">__int64</span><span class="p">,</span><span class="n">unsigned</span> <span class="n">__int64</span><span class="p">)</span>
<span class="hll">       <span class="mi">43036</span>          <span class="mi">106</span>  <span class="n">public</span><span class="p">:</span> <span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">operator</span><span class="o">--</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
</span><span class="hll">       <span class="mi">42840</span>          <span class="mi">126</span>  <span class="n">protected</span><span class="p">:</span> <span class="n">void</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Lrotate</span><span class="p">(</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span>
</span><span class="hll">       <span class="mi">42840</span>          <span class="mi">126</span>  <span class="n">protected</span><span class="p">:</span> <span class="n">void</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Rrotate</span><span class="p">(</span><span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span>
</span>       <span class="mi">42284</span>          <span class="mi">341</span>  <span class="n">protected</span><span class="p">:</span> <span class="n">void</span> <span class="n">__cdecl</span> <span class="n">idStr</span><span class="p">::</span><span class="n">Init</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
       <span class="mi">41460</span>           <span class="mi">28</span>  <span class="n">private</span><span class="p">:</span> <span class="n">void</span> <span class="n">__cdecl</span> <span class="err">`</span><span class="n">anonymous</span> <span class="n">namespace</span><span class="s1">&#39;</span>
<span class="hll">       <span class="mi">37736</span>          <span class="mi">106</span>  <span class="n">public</span><span class="p">:</span> <span class="n">struct</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_buy</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">_Buynode0</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
</span><span class="hll">       <span class="mi">35658</span>          <span class="mi">126</span>  <span class="n">public</span><span class="p">:</span> <span class="nb">bool</span> <span class="n">__cdecl</span> <span class="n">std</span><span class="p">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">operator</span><span class="o">==</span><span class="p">(</span><span class="k">class</span> <span class="nc">std</span><span class="p">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">const</span> <span class="o">&amp;</span><span class="p">)</span><span class="n">const</span> 
</span>       <span class="mi">35406</span>           <span class="mi">42</span>  <span class="n">public</span><span class="p">:</span> <span class="nb">bool</span> <span class="n">__cdecl</span> <span class="n">idBounds</span><span class="p">::</span><span class="n">AddPoint</span><span class="p">(</span><span class="k">class</span> <span class="nc">idVec3</span> <span class="n">const</span> <span class="o">&amp;</span><span class="p">)</span>
       <span class="o">...</span>            <span class="o">...</span>  <span class="o">...</span>
</pre></div>


<p>Note that the very first symbol <code>ATL::CTrace::m_nMap</code> is a .bss symbol, so it does not take compiler's time. The second symbol <code>`string'</code> corresponds to all string constants compiled, so it is not code also. Among the rest, <code>std::_Tree</code> pieces are consistently in the top =) Some methods of <code>idList&lt;T&gt;</code> are also noticeable. It would be great to know how much code is generated for <code>idList</code> class in total, but the original SymbolSort does not provide such insight.</p>
<h2 id="improvements"><a class="toclink" href="#improvements">Improvements</a></h2>
<p>As you see above, the original version of SymbolSort lacks one important feature on .obj input: you cannot learn how much code a template class is generating. This could be especially useful for widely used generic template classes, in particular for templates like <code>idList</code> and <code>std::set</code>. There are two approaches to provide this functionality:</p>
<ul>
<li>
<p><strong>PDB.</strong> Attribute each symbol to the source or header file where its implementation is physically located, instead of attributing it to the .obj file where it is compiled. As the result, the stats for the header file (where template is defined) in the "file contributions" section should give the wanted information.</p>
</li>
<li>
<p><strong>classpath.</strong> Extract classpath from the name of each symbol, which shows the class name with all namespaces containing it, e.g. <code>boost::container::deque</code>. Then show amount of code with each classpath. In addition, statistics per namespaces (e.g. <code>boost</code>) can be shown just like statistics per directories are shows in "file contributions" section.</p>
</li>
</ul>
<p>Both approaches are implemented in the updated version of SymbolSort (currently available in <a href="https://github.com/stgatilov/SymbolSort">my fork</a>). The classpath approach works without any additional input, as long as <code>undname.exe</code> tool is in PATH. The PDB approach (as the name suggests) requires .pdb files to be provided using <code>-info</code> parameters. For the bloatinfo.py script, it is enough to simply provide the root directory containing the .pdb files:</p>
<div class="highlight"><pre><span></span>bloatinfo --obj=. --pdb=exeDir --dump --analyze
</pre></div>


<p>The script passes all the .pdb files present in this directory to SymbolSort. Here is the full list of command line arguments passed to SymbolSort in my case (seen in <code>options.txt</code> file):</p>
<div class="highlight"><pre><span></span>-out object_files.report
-in:comdat .\DarkModTools\all_obj.smb -in:comdat .\idLib\all_obj.smb
-info exeDir\TheDarkModx64.pdb              # determine code location (source file) using this pdb
</pre></div>


<p>As usual, you can <a href="https://dirtyhandscoding.github.io/code/7_symbolsort/improved.report">download the full report</a>. It differs from the previous one in only two sections: "file contributions" and newly added "namespaces and classes contributions". Here you can see the first one, which shows results of the PDB approach:</p>
<div class="highlight"><pre><span></span><span class="n">File</span> <span class="n">Contributions</span>
<span class="o">--------------------------------------</span>
<span class="n">Sorted</span> <span class="n">by</span> <span class="n">Size</span>
        <span class="n">Size</span>   <span class="n">Count</span>  <span class="n">Source</span> <span class="n">Path</span>
    <span class="mi">16996266</span>   <span class="mi">99982</span>  <span class="n">c:</span>
    <span class="mi">13219968</span>   <span class="mi">65465</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span>
     <span class="mi">4986400</span>   <span class="mi">24553</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">game</span>
     <span class="mi">4385995</span>   <span class="mi">22000</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">idlib</span>
     <span class="mi">3776298</span>   <span class="mi">34517</span>  <span class="n">c:</span><span class="o">\</span><span class="n">program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">\</span><span class="n">microsoft</span> <span class="n">visual</span> <span class="n">studio</span> <span class="mf">12.0</span><span class="o">\</span><span class="n">vc</span>
     <span class="mi">3748270</span>   <span class="mi">23115</span>  <span class="p">[</span><span class="n">not_in_pdb</span><span class="p">]</span>
     <span class="mi">3646356</span>   <span class="mi">33365</span>  <span class="n">c:</span><span class="o">\</span><span class="n">program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">\</span><span class="n">microsoft</span> <span class="n">visual</span> <span class="n">studio</span> <span class="mf">12.0</span><span class="o">\</span><span class="n">vc</span><span class="o">\</span><span class="n">include</span>
     <span class="mi">1965992</span>    <span class="mi">8770</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">tools</span>
     <span class="mi">1594575</span>    <span class="mi">6939</span>  <span class="n">c:</span><span class="o">\</span><span class="n">program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">\</span><span class="n">microsoft</span> <span class="n">visual</span> <span class="n">studio</span> <span class="mf">12.0</span><span class="o">\</span><span class="n">vc</span><span class="o">\</span><span class="n">include</span><span class="o">\</span><span class="n">xtree</span>
     <span class="mi">1348758</span>    <span class="mi">7184</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">idlib</span><span class="o">\</span><span class="n">math</span>
     <span class="mi">1255015</span>    <span class="mi">7762</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">game</span><span class="o">\</span><span class="n">ai</span>
      <span class="mi">952373</span>    <span class="mi">3052</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">tools</span><span class="o">\</span><span class="n">radiant</span>
      <span class="mi">866746</span>     <span class="mi">424</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">idlib</span><span class="o">\</span><span class="n">precompiled</span><span class="o">.</span><span class="n">cpp</span>
      <span class="mi">837893</span>    <span class="mi">6008</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">idlib</span><span class="o">\</span><span class="n">containers</span>
      <span class="mi">716211</span>    <span class="mi">5007</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">idlib</span><span class="o">\</span><span class="n">containers</span><span class="o">\</span><span class="n">list</span><span class="o">.</span><span class="n">h</span>
      <span class="mi">682448</span>    <span class="mi">1730</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">renderer</span>
      <span class="mi">522322</span>    <span class="mi">3779</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">framework</span>
      <span class="mi">456809</span>    <span class="mi">1828</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">game</span><span class="o">\</span><span class="n">physics</span>
      <span class="mi">446605</span>    <span class="mi">7671</span>  <span class="n">c:</span><span class="o">\</span><span class="n">program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">\</span><span class="n">microsoft</span> <span class="n">visual</span> <span class="n">studio</span> <span class="mf">12.0</span><span class="o">\</span><span class="n">vc</span><span class="o">\</span><span class="n">include</span><span class="o">\</span><span class="n">xmemory0</span>
      <span class="mi">392003</span>    <span class="mi">2832</span>  <span class="n">c:</span><span class="o">\</span><span class="n">program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">\</span><span class="n">microsoft</span> <span class="n">visual</span> <span class="n">studio</span> <span class="mf">12.0</span><span class="o">\</span><span class="n">vc</span><span class="o">\</span><span class="n">include</span><span class="o">\</span><span class="n">xstring</span>
      <span class="mi">371915</span>    <span class="mi">4260</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">idlib</span><span class="o">\</span><span class="n">str</span><span class="o">.</span><span class="n">h</span>
      <span class="mi">340839</span>    <span class="mi">5005</span>  <span class="n">c:</span><span class="o">\</span><span class="n">program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">\</span><span class="n">microsoft</span> <span class="n">visual</span> <span class="n">studio</span> <span class="mf">12.0</span><span class="o">\</span><span class="n">vc</span><span class="o">\</span><span class="n">include</span><span class="o">\</span><span class="n">memory</span>
      <span class="mi">337826</span>    <span class="mi">3349</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">idlib</span><span class="o">\</span><span class="n">math</span><span class="o">\</span><span class="n">vector</span><span class="o">.</span><span class="n">h</span>
      <span class="mi">323912</span>     <span class="mi">659</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">idlib</span><span class="o">\</span><span class="n">geometry</span>
      <span class="mi">322392</span>    <span class="mi">1728</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">game</span><span class="o">\</span><span class="n">gamesys</span>
      <span class="mi">315030</span>    <span class="mi">1384</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">game</span><span class="o">\</span><span class="n">ai</span><span class="o">\</span><span class="n">ai</span><span class="o">.</span><span class="n">cpp</span>
      <span class="mi">296359</span>     <span class="mi">693</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">tools</span><span class="o">\</span><span class="n">compilers</span>
      <span class="mi">288751</span>     <span class="mi">809</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">idlib</span><span class="o">\</span><span class="n">bv</span>
      <span class="mi">280758</span>     <span class="mi">129</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">idlib</span><span class="o">\</span><span class="n">math</span><span class="o">\</span><span class="n">matrix</span><span class="o">.</span><span class="n">cpp</span>
      <span class="mi">280446</span>    <span class="mi">1479</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">game</span><span class="o">\</span><span class="n">ai</span><span class="o">\</span><span class="n">states</span>
      <span class="mi">262804</span>    <span class="mi">1280</span>  <span class="n">c:</span><span class="o">\</span><span class="n">thedarkmod</span><span class="o">\</span><span class="n">darkmod_src</span><span class="o">\</span><span class="n">ui</span>
      <span class="mi">256771</span>    <span class="mi">3436</span>  <span class="p">[</span><span class="n">unclear_source</span><span class="p">]</span>
        <span class="o">...</span>      <span class="o">...</span>  <span class="o">...</span>
</pre></div>


<p>We can learn a lot of things from this list:</p>
<ol>
<li>The whole C/C++ standard library generates 3.7 MB of object code.</li>
<li>Implementation of <code>std::set</code> / <code>std::map</code> (<code>xtree</code>) generates at least 1.5 MB of code. 800 KB is generated by STL memory management, perhaps also for set/map. Despite being rarely used, <code>std::string</code> seems to gen 400 KB --- a bit more than widely used <code>idStr</code> from <code>str.h</code>.</li>
<li><code>idList</code> from <code>list.h</code> generates only 700 KB of code --- that's a very little. <code>idStr</code> generates 370 KB, and all vector math generates 330 KB.</li>
<li>Among different components: game logic (<code>game</code>) generates 5 MB, the ID's generic library (idlib) generates 4.4 MB, in-game tools (<code>tools</code>) generates 2 MB, framework (<code>framework</code>) generates 500 KB, and the renderer core (<code>renderer</code> --- written in C) generates 700 KB. Probably the results would be more precise if we remove bss and data sections from here.</li>
</ol>
<p>A minor nuisance of this report is that we see two special filenames: <code>[not_in_pdb]</code> and <code>[unclear_source]</code>. These categories contain all symbols for which SymbolSort failed to find proper location.
A symbol gets into <code>[unclear_source]</code> when it has some code and is present in PDB, but it does not have any source code location. Mainly, these are all the implicitly generated class methods: automatically generated constructors, destructors and assignment operators. Here are some examples:</p>
<div class="highlight"><pre><span></span><span class="k">public</span><span class="o">:</span> <span class="k">virtual</span> <span class="kt">void</span> <span class="o">*</span> <span class="kr">__cdecl</span> <span class="n">idAASLocal</span><span class="o">::</span><span class="err">`</span><span class="n">scalar</span> <span class="n">deleting</span> <span class="n">destructor</span><span class="err">&#39;</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
<span class="k">public</span><span class="o">:</span> <span class="kt">void</span> <span class="o">*</span> <span class="kr">__cdecl</span> <span class="n">eas</span><span class="o">::</span><span class="n">tdmEAS</span><span class="o">::</span><span class="err">`</span><span class="n">scalar</span> <span class="n">deleting</span> <span class="n">destructor</span><span class="err">&#39;</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
<span class="k">public</span><span class="o">:</span> <span class="kt">void</span> <span class="o">*</span> <span class="kr">__cdecl</span> <span class="n">idList</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">SBoolParseNode</span><span class="o">&gt;::</span><span class="err">`</span><span class="n">vector</span> <span class="n">deleting</span> <span class="n">destructor</span><span class="err">&#39;</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
<span class="k">public</span><span class="o">:</span> <span class="k">class</span> <span class="nc">idAASSettings</span> <span class="o">&amp;</span> <span class="kr">__cdecl</span> <span class="n">idAASSettings</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">class</span> <span class="nc">idAASSettings</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span>
<span class="k">public</span><span class="o">:</span> <span class="kr">__cdecl</span> <span class="n">idDrawVert</span><span class="o">::</span><span class="n">idDrawVert</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="k">public</span><span class="o">:</span> <span class="k">class</span> <span class="nc">idSurface</span> <span class="o">&amp;</span> <span class="kr">__cdecl</span> <span class="n">idSurface</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">class</span> <span class="nc">idSurface</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span>
<span class="kt">void</span> <span class="kr">__cdecl</span> <span class="err">`</span><span class="n">vector</span> <span class="n">constructor</span> <span class="n">iterator</span><span class="err">&#39;</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span>
<span class="kt">void</span> <span class="kr">__cdecl</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Library</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">State</span><span class="o">&gt;::</span><span class="n">Instance</span> <span class="o">&amp;</span> <span class="kr">__cdecl</span> <span class="n">ai</span><span class="o">::</span><span class="n">Library</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">State</span><span class="o">&gt;::</span><span class="n">Instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">2</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="n">dynamic</span> <span class="n">atexit</span> <span class="n">destructor</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">_instance</span><span class="err">&#39;&#39;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="k">public</span><span class="o">:</span> <span class="kr">__cdecl</span> <span class="n">std</span><span class="o">::</span><span class="n">_Tree_buy</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">CFrobDoor</span> <span class="o">*&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">CFrobDoor</span> <span class="o">*&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;::~</span><span class="n">_Tree_buy</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">CFrobDoor</span> <span class="o">*&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">CFrobDoor</span> <span class="o">*&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="k">public</span><span class="o">:</span> <span class="kr">__cdecl</span> <span class="n">std</span><span class="o">::</span><span class="n">_Iterator012</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">bidirectional_iterator_tag</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">Task</span><span class="o">&gt;</span> <span class="kr">__cdecl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span><span class="kr">__int64</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">Task</span><span class="o">&gt;</span> <span class="kr">__cdecl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">Task</span><span class="o">&gt;</span> <span class="kr">__cdecl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">_Iterator_base12</span><span class="o">&gt;::</span><span class="n">_Iterator012</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">bidirectional_iterator_tag</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">Task</span><span class="o">&gt;</span> <span class="kr">__cdecl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span><span class="kr">__int64</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">Task</span><span class="o">&gt;</span> <span class="kr">__cdecl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">Task</span><span class="o">&gt;</span> <span class="kr">__cdecl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">_Iterator_base12</span><span class="o">&gt;</span><span class="p">(</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">_Iterator012</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">bidirectional_iterator_tag</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">Task</span><span class="o">&gt;</span> <span class="kr">__cdecl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span><span class="kr">__int64</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">Task</span><span class="o">&gt;</span> <span class="kr">__cdecl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">ai</span><span class="o">::</span><span class="n">Task</span><span class="o">&gt;</span> <span class="kr">__cdecl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">_Iterator_base12</span><span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span>
</pre></div>


<p>The larger <code>[not_in_pdb]</code> category is comprised of symbols which are not present in PDB. They are: initialization/finalization code for global and static variables, static functions, exception handling, runtime check cookies. Here are some examples:</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="err">`</span><span class="n">dynamic</span> <span class="n">initializer</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">engineVersion</span><span class="err">&#39;&#39;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="kt">void</span> <span class="kr">__cdecl</span> <span class="n">std</span><span class="o">::</span><span class="err">`</span><span class="n">dynamic</span> <span class="n">initializer</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">piecewise_construct</span><span class="err">&#39;&#39;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="kt">void</span> <span class="kr">__cdecl</span> <span class="err">`</span><span class="n">dynamic</span> <span class="n">initializer</span> <span class="k">for</span> <span class="err">&#39;</span><span class="k">public</span><span class="o">:</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">idTypeInfo</span> <span class="n">CAbsenceMarker</span><span class="o">::</span><span class="n">Type</span><span class="err">&#39;&#39;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="kt">void</span> <span class="kr">__cdecl</span> <span class="err">`</span><span class="n">dynamic</span> <span class="n">atexit</span> <span class="n">destructor</span> <span class="k">for</span> <span class="err">&#39;</span><span class="k">public</span><span class="o">:</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">idTypeInfo</span> <span class="n">CAbsenceMarker</span><span class="o">::</span><span class="n">Type</span><span class="err">&#39;&#39;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="kt">int</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Alloc</span> <span class="o">*</span> <span class="kr">__cdecl</span> <span class="n">idAAS</span><span class="o">::</span><span class="n">Alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">1</span><span class="err">&#39;</span><span class="o">::</span><span class="n">dtor</span><span class="err">$</span><span class="mi">0</span>
<span class="kt">int</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="k">virtual</span> <span class="kt">void</span> <span class="kr">__cdecl</span> <span class="n">idAASLocal</span><span class="o">::</span><span class="n">DeReferenceDoor</span><span class="p">(</span><span class="k">class</span> <span class="nc">CFrobDoor</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">1</span><span class="err">&#39;</span><span class="o">::</span><span class="n">dtor</span><span class="err">$</span><span class="mi">0</span>
<span class="kt">int</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="k">class</span> <span class="nc">dtor</span><span class="err">$</span><span class="mi">0</span> <span class="o">&amp;</span> <span class="kr">__cdecl</span> <span class="n">idList</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">idDrawVert</span><span class="o">&gt;::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">class</span> <span class="nc">dtor</span><span class="err">$</span><span class="mi">0</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">1</span><span class="err">&#39;</span><span class="o">::</span><span class="n">dtor</span><span class="err">$</span><span class="mi">0</span>
<span class="kt">int</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="kt">void</span> <span class="kr">__cdecl</span> <span class="n">idAASLocal</span><span class="o">::</span><span class="n">ShowArea</span><span class="p">(</span><span class="k">class</span> <span class="nc">idVec3</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span><span class="k">const</span> <span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">2</span><span class="err">&#39;</span><span class="o">::</span><span class="n">lastAreaNum</span>
<span class="k">class</span> <span class="nc">idPlane</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="k">virtual</span> <span class="k">class</span> <span class="nc">idPlane</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="kr">__cdecl</span> <span class="n">idAASLocal</span><span class="o">::</span><span class="n">GetPlane</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">const</span> <span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">5</span><span class="err">&#39;</span><span class="o">::</span><span class="n">dummy</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="k">virtual</span> <span class="k">class</span> <span class="nc">idPlane</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="kr">__cdecl</span> <span class="n">idAASLocal</span><span class="o">::</span><span class="n">GetPlane</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">const</span> <span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">5</span><span class="err">&#39;</span><span class="o">::</span><span class="err">$</span><span class="n">S5</span>
<span class="kt">void</span> <span class="kr">__cdecl</span> <span class="n">Com_EditSounds_f</span><span class="p">(</span><span class="k">class</span> <span class="nc">idCmdArgs</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span>
<span class="kt">int</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">idClass</span> <span class="o">*</span> <span class="kr">__cdecl</span> <span class="n">CAbsenceMarker</span><span class="o">::</span><span class="n">CreateInstance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">1</span><span class="err">&#39;</span><span class="o">::</span><span class="k">catch</span><span class="err">$</span><span class="mi">0</span>
<span class="k">public</span><span class="o">:</span> <span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span> <span class="n">std</span><span class="o">::</span><span class="n">_Error_objects</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">_Iostream_object</span><span class="err">$</span><span class="n">initializer</span><span class="err">$</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span>
<span class="hll"><span class="n">S12</span><span class="o">&lt;</span><span class="err">`</span><span class="k">template</span><span class="o">-</span><span class="n">parameter</span><span class="o">-</span><span class="mi">2</span><span class="err">&#39;</span><span class="p">,</span><span class="n">idAFEntity_VehicleSimple</span><span class="o">::</span><span class="n">wn</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="o">??</span> <span class="o">&amp;&gt;</span>
</span><span class="kt">int</span> <span class="err">`</span><span class="k">public</span><span class="o">:</span> <span class="kt">void</span> <span class="kr">__cdecl</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">enum</span> <span class="n">ai</span><span class="o">::</span><span class="n">EAlertState</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">idStr</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">void</span> <span class="o">*&gt;</span> <span class="o">&gt;::</span><span class="n">construct</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">enum</span> <span class="n">ai</span><span class="o">::</span><span class="n">EAlertState</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">idStr</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">void</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">enum</span> <span class="n">ai</span><span class="o">::</span><span class="n">EAlertState</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">idStr</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">void</span> <span class="o">*&gt;</span> <span class="o">*</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="k">struct</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">enum</span> <span class="n">ai</span><span class="o">::</span><span class="n">EAlertState</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">idStr</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">void</span> <span class="o">*&gt;</span> <span class="o">&gt;::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">enum</span> <span class="n">ai</span><span class="o">::</span><span class="n">EAlertState</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">idStr</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">void</span> <span class="o">*&gt;</span> <span class="o">*</span> <span class="o">*</span><span class="p">,</span><span class="k">struct</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">_Tree_node</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">enum</span> <span class="n">ai</span><span class="o">::</span><span class="n">EAlertState</span> <span class="k">const</span> <span class="p">,</span><span class="k">class</span> <span class="nc">idStr</span><span class="o">&gt;</span><span class="p">,</span><span class="kt">void</span> <span class="o">*&gt;</span> <span class="o">&gt;::</span><span class="n">std</span> <span class="o">*</span> <span class="o">&amp;</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">1</span><span class="err">&#39;</span><span class="o">::</span><span class="n">dtor</span><span class="err">$</span><span class="mi">0</span>
<span class="o">?</span><span class="n">ToString</span><span class="err">@</span><span class="n">idBox</span><span class="err">@@</span><span class="n">QEBAPEBDH</span><span class="err">@</span><span class="n">Z</span><span class="err">$</span><span class="n">rtcName</span><span class="err">$</span><span class="mi">0</span>
</pre></div>


<p>It is indeed very enlightening to look at all this crazy stuff and try to understand what it is about =) Still have no idea what the hell the highlighted line is. It looks like even the undecorating code did not work properly for that symbol.</p>
<hr>
<p>And now let's look at the new section called "Namespaces and classes contributions", which is the outcome of the "classpath" approach discussed above. Note that the individual methods are not shown here, because the last component of classpath (which is usually method name) is stripped off. The leading <code>.::</code> is added for implementation simplicity.</p>
<div class="highlight"><pre><span></span><span class="n">Namespaces</span> <span class="n">and</span> <span class="n">classes</span> <span class="n">Contributions</span>
<span class="o">--------------------------------------</span>
<span class="n">Sorted</span> <span class="n">by</span> <span class="n">Size</span>
        <span class="n">Size</span>   <span class="n">Count</span>  <span class="n">Source</span> <span class="n">Path</span>
    <span class="mi">20763966</span>  <span class="mi">125021</span>  <span class="p">.</span>
    <span class="mi">4482084</span>   <span class="mi">45792</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span>
<span class="hll">    <span class="mi">1210159</span>    <span class="mi">3772</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">_Tree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span>    <span class="mi">1037109</span>    <span class="mi">2296</span>  <span class="p">.</span><span class="o">::</span><span class="n">ATL</span>
    <span class="mi">954888</span>     <span class="mi">738</span>  <span class="p">.</span><span class="o">::</span><span class="n">ATL</span><span class="o">::</span><span class="n">CTrace</span>
    <span class="mi">731544</span>    <span class="mi">5265</span>  <span class="p">.</span><span class="o">::</span><span class="n">idList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="mi">654808</span>    <span class="mi">3972</span>  <span class="p">.</span><span class="o">::</span><span class="n">ai</span>
    <span class="mi">417844</span>    <span class="mi">4085</span>  <span class="p">.</span><span class="o">::</span><span class="n">idStr</span>
    <span class="mi">375015</span>     <span class="mi">829</span>  <span class="p">.</span><span class="o">::</span><span class="n">idAI</span>
    <span class="mi">349640</span>    <span class="mi">2411</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="mi">289220</span>    <span class="mi">2598</span>  <span class="p">.</span><span class="o">::</span><span class="n">idVec3</span>
    <span class="mi">281714</span>     <span class="mi">502</span>  <span class="p">.</span><span class="o">::</span><span class="n">idPlayer</span>
    <span class="mi">237341</span>    <span class="mi">1512</span>  <span class="p">[</span><span class="n">unknown</span><span class="p">]</span>
    <span class="mi">203972</span>    <span class="mi">1032</span>  <span class="p">.</span><span class="o">::</span><span class="n">idEntity</span>
<span class="hll">    <span class="mi">190771</span>    <span class="mi">1284</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">_Tree_const_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span>    <span class="mi">189928</span>     <span class="mi">738</span>  <span class="p">.</span><span class="o">::</span><span class="n">idBounds</span>
    <span class="mi">175113</span>    <span class="mi">3761</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="mi">171348</span>     <span class="mi">232</span>  <span class="p">.</span><span class="o">::</span><span class="n">idCollisionModelManagerLocal</span>
<span class="hll">    <span class="mi">166539</span>    <span class="mi">1258</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">_Tree_alloc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span>    <span class="mi">165286</span>    <span class="mi">2140</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="mi">153105</span>     <span class="mi">293</span>  <span class="p">.</span><span class="o">::</span><span class="n">idGameLocal</span>
    <span class="mi">152834</span>    <span class="mi">1480</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">_Iterator_base12</span>
    <span class="mi">152768</span>    <span class="mi">2514</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">_Wrap_alloc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="mi">150042</span>     <span class="mi">757</span>  <span class="p">.</span><span class="o">::</span><span class="n">idMat3</span>
    <span class="mi">145294</span>      <span class="mi">62</span>  <span class="p">.</span><span class="o">::</span><span class="n">idRenderMatrix</span>
    <span class="mi">131388</span>     <span class="mi">283</span>  <span class="p">.</span><span class="o">::</span><span class="n">idMatX</span>
    <span class="mi">128163</span>     <span class="mi">453</span>  <span class="p">.</span><span class="o">::</span><span class="n">idClass</span>
    <span class="mi">126683</span>    <span class="mi">2332</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">_Ref_count</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="mi">122005</span>    <span class="mi">1541</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">_Func_impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="mi">121407</span>     <span class="mi">294</span>  <span class="p">.</span><span class="o">::</span><span class="n">idWindow</span>
    <span class="mi">112618</span>     <span class="mi">396</span>  <span class="p">.</span><span class="o">::</span><span class="n">ai</span><span class="o">::</span><span class="n">State</span>
<span class="hll">    <span class="mi">109591</span>     <span class="mi">746</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">_Tree_buy</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span>    <span class="mi">105087</span>    <span class="mi">1042</span>  <span class="p">.</span><span class="o">::</span><span class="n">idDict</span>
    <span class="mi">102964</span>     <span class="mi">827</span>  <span class="p">.</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">_Func_class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
       <span class="p">...</span>     <span class="p">...</span>  <span class="p">...</span>
</pre></div>


<p>Here are some notes about these results:</p>
<ol>
<li>With all the non-PDB symbols, STL generates 4.5 MB of code. Out of which at least 1.6 MB are done by highlighted classes, which comprise set/map implementation.</li>
<li>It looks like <code>ATL::CTrace</code> generates 1 MB of code, but judging from the other parts of the report, most of this size consists of <code>.bss</code> symbols, i.e. not code at all.</li>
<li>We confirm that <code>idList</code> template class generates 730 KB of code, <code>idStr</code> generates 420 KB.</li>
<li>Among vector math, <code>idVec3</code> is obviously the most popular: it generates 290 KB of code. Classes <code>idBounds</code> and <code>idMat3</code> are also rather widely used.</li>
<li>The whole <code>ai</code> namespace (AI of TDM) generates 650 KB of object code.</li>
</ol>
<p>As with PDB approach shown previously, here we also see some symbols with <code>[unknown]</code> classpath. It is hard to say exactly why are they unclassified, but given that classpath extraction is done (partly) with manual regex-based recognition, there is no surprise that some crazy cases are not working. The typical problematic cases are: anonymous namespaces and lambda functions. The other fails are complex examples, where single pattern is not enough to deduce classpath.
Here are some examples:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">idStr</span> <span class="kr">__cdecl</span> <span class="err">`</span><span class="n">anonymous</span> <span class="k">namespace</span><span class="err">&#39;</span><span class="o">::</span><span class="n">NormalisePath</span><span class="p">(</span><span class="k">class</span> <span class="nc">idStr</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span>
<span class="kt">void</span> <span class="kr">__cdecl</span> <span class="n">VertexMinMax</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">&lt;</span><span class="nc">lambda_e15de9cdacbee52611b15ce13c2dbb01</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">(</span><span class="k">class</span> <span class="nc">idVec3</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">class</span> <span class="nc">idVec3</span> <span class="o">&amp;</span><span class="p">,</span><span class="k">class</span> <span class="nc">idDrawVert</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="k">class</span> <span class="err">&lt;</span><span class="nc">lambda_e15de9cdacbee52611b15ce13c2dbb01</span><span class="o">&gt;</span><span class="p">)</span>
<span class="kt">bool</span> <span class="kr">__cdecl</span> <span class="err">`</span><span class="n">anonymous</span> <span class="k">namespace</span><span class="err">&#39;</span><span class="o">::</span><span class="n">convert_buffer_utf16</span><span class="o">&lt;</span><span class="k">struct</span> <span class="err">`</span><span class="n">anonymous</span> <span class="k">namespace</span><span class="err">&#39;</span><span class="o">::</span><span class="n">opt_false</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="o">&amp;</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="o">&amp;</span><span class="p">,</span><span class="kt">void</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">,</span><span class="k">struct</span> <span class="n">A0xa82155d7</span><span class="o">::</span><span class="n">opt_false</span><span class="p">)</span>
<span class="o">?</span><span class="n">parse</span><span class="err">@</span><span class="n">xml_parser</span><span class="err">@</span><span class="o">?</span><span class="n">A0xa82155d7</span><span class="err">@@</span><span class="n">SA</span><span class="o">?</span><span class="n">AUxml_parse_result</span><span class="err">@</span><span class="n">pugi</span><span class="err">@@</span><span class="n">PEAD_KPEAUxml_node_struct</span><span class="err">@</span><span class="mi">4</span><span class="err">@</span><span class="n">I</span><span class="err">@</span><span class="n">Z</span><span class="err">$</span><span class="n">rtcName</span><span class="err">$</span><span class="mi">0</span>
<span class="kt">int</span> <span class="err">`</span><span class="k">class</span> <span class="nc">catch</span><span class="err">$</span><span class="mi">0</span><span class="o">::</span><span class="n">basic_ostream</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&amp;</span> <span class="kr">__cdecl</span> <span class="n">std</span><span class="o">::</span><span class="k">operator</span><span class="o">&lt;&lt;&lt;</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">(</span><span class="k">class</span> <span class="nc">catch</span><span class="err">$</span><span class="mi">0</span><span class="o">::</span><span class="n">std</span> <span class="o">&amp;</span><span class="p">,</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">1</span><span class="err">&#39;</span><span class="o">::</span><span class="k">catch</span><span class="err">$</span><span class="mi">0</span>
<span class="kt">int</span> <span class="err">`</span><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="err">`</span><span class="n">dynamic</span> <span class="n">initializer</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">sLootTypeName</span><span class="err">&#39;&#39;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="err">&#39;</span><span class="o">::</span><span class="err">`</span><span class="mi">1</span><span class="err">&#39;</span><span class="o">::</span><span class="n">dtor</span><span class="err">$</span><span class="mi">0</span>
<span class="kt">void</span> <span class="kr">__cdecl</span> <span class="err">`</span><span class="n">dynamic</span> <span class="n">initializer</span> <span class="k">for</span> <span class="err">&#39;</span><span class="k">public</span><span class="o">:</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">idCVar</span> <span class="o">&lt;</span><span class="n">unnamed</span><span class="o">-</span><span class="n">tag</span><span class="o">&gt;::</span><span class="n">in_mouse</span><span class="err">&#39;&#39;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="k">class</span> <span class="err">&lt;</span><span class="nc">lambda_e261b9d4d68e91887cf921d793e3e07c</span><span class="o">&gt;</span> <span class="err">`</span><span class="n">RTTI</span> <span class="n">Type</span> <span class="n">Descriptor</span><span class="err">&#39;</span>
<span class="p">[</span><span class="n">thunk</span><span class="p">]</span><span class="o">:</span> <span class="kr">__cdecl</span> <span class="n">CBinaryFrobMover</span><span class="o">::</span><span class="err">`</span><span class="n">vcall</span><span class="err">&#39;</span><span class="p">{</span><span class="mi">1032</span><span class="p">,{</span><span class="n">flat</span><span class="p">}}</span><span class="err">&#39;</span> <span class="p">}</span><span class="err">&#39;</span>
</pre></div>


<p>As you see, both approaches are not perfect. Both of them sometimes misinterpret or fail to interpret some symbols. But note that it is very hard to even define exactly how to determine source file and owning class for every symbol. The whole analysis is approximate anyway.</p>
<h2 id="implementation-details"><a class="toclink" href="#implementation-details">Implementation details</a></h2>
<h3 id="pdb-approach"><a class="toclink" href="#pdb-approach">PDB approach</a></h3>
<p>It is impossible to detect source code locations of functions using .obj files only, but this information is available in .pdb file. That's why .pdb files must be specified in order to attribute symbols from .obj files to the headers where they are defined. The new parameter <code>-info</code> is introduced to specify such .pdb files: these files are read as usual, but their contents are not counted in the reported statistics. The only way how the contents of these .pdb files influence the report is that the source filenames of all symbols are deduced from them.</p>
<p>If no parameters are specified with <code>-info</code> key, then the analysis is performed the old way, i.e. each symbol is attributed to the .obj file where it is compiled. If at least one <code>-info</code> parameter is specified, then the filename replacing is performed. Aside from that, the analysis continues as usual.</p>
<p>Every pdb file specified as <code>-info</code> is read, and all the symbols are put into special storage. These symbols do not get into the main storage, where the symbols read from .obj files are located. Now we establish correspondence between the symbols of the two storages. For each symbol from the main storage, we find a symbol in special pdb storage with same name, and take its filename to replace the original one.</p>
<div class="highlight"><pre><span></span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Connecting symbols to PDB info...&quot;</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">connectedCnt</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">allCnt</span> <span class="p">=</span> <span class="n">symbols</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="n">Symbol</span> <span class="n">s</span> <span class="k">in</span> <span class="n">symbols</span><span class="p">)</span>       <span class="c1">//&quot;symbols&quot;  --- main storage</span>
<span class="p">{</span>                                   <span class="c1">//&quot;infoDict&quot; --- special pdb storage</span>
    <span class="n">Symbol</span> <span class="n">info</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">infoDict</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">raw_name</span><span class="p">,</span> <span class="k">out</span> <span class="n">info</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">connectedCnt</span><span class="p">++;</span>
<span class="hll">        <span class="n">s</span><span class="p">.</span><span class="n">source_filename</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">source_filename</span><span class="p">;</span>
</span>    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">s</span><span class="p">.</span><span class="n">source_filename</span> <span class="p">=</span> <span class="s">&quot;[not_in_pdb]&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Connected {0}% symbols ({1}/{2})&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)(</span><span class="m">100.0</span> <span class="p">*</span> <span class="n">connectedCnt</span> <span class="p">/</span> <span class="n">allCnt</span><span class="p">),</span> <span class="n">connectedCnt</span><span class="p">,</span> <span class="n">allCnt</span><span class="p">);</span>
</pre></div>


<p>The source filename replacement happens in the highlighted line. Here is an example for one symbol:</p>
<div class="highlight"><pre><span></span><span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;public: __cdecl idList&lt;class idVec4&gt;::~idList&lt;class idVec4&gt;(void)&quot;</span>
<span class="n">s</span><span class="p">.</span><span class="n">raw_name</span> <span class="p">=</span> <span class="s">&quot;??1?$idList@VidVec4@@@@QEAA@XZ&quot;</span>
<span class="n">s</span><span class="p">.</span><span class="n">source_filename</span> <span class="p">=</span> <span class="s">&quot;.\DarkModTools\AAS.obj&quot;</span>                                <span class="c1">// the original source filename (replaced)</span>
<span class="n">info</span><span class="p">.</span><span class="n">source_filename</span> <span class="p">=</span> <span class="s">&quot;c:\thedarkmod\darkmod_src\idlib\containers\list.h&quot;</span>  <span class="c1">// the source filename from PDB (taken)</span>
</pre></div>


<p>Correspondence between symbols is established based on their raw names, i.e. the decorated/mangled names. The original version of SymbolSort did not read these names neither from comdat nor from PDB inputs, so the code must have been extended for it. Let's start with comdat output of .obj file. Here is how it looks like:</p>
<div class="highlight"><pre><span></span>SECTION HEADER #30
.text$mn name
       0 physical address
       0 virtual address
      2E size of raw data
    87CC file pointer to raw data (000087CC to 000087F9)
    87FA file pointer to relocation table
       0 file pointer to line numbers
       1 number of relocations
       0 number of line numbers
60501020 flags
         Code
<span class="hll">         COMDAT; sym= &quot;public: __cdecl idList&lt;class idVec4&gt;::~idList&lt;class idVec4&gt;(void)&quot; (??1?$idList@VidVec4@@@@QEAA@XZ)
</span>         16 byte align
         Execute Read
</pre></div>


<p>The undecorated name is extracted from the highlighted line using simple regex, and it is trivial to extend the regex to extract the raw name as well.</p>
<p>For the PDB file, extracting decorated name is a bit harder. It turns out that there is a major distinction between <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/public-and-private-symbols">public and private symbols in PDB</a>. In particular, all public symbols have raw symbol name stored in <code>IDiaSymbol.name</code>, while private symbols have human-readable name stored in it. Unfortunately, I did not know about this distinction, and SymbolSort extracts only private symbols by default, so I spent a lot of time trying to get raw name out of private <code>IDiaSymbol</code>-s. I even found one way which works for most private symbols for no apparent reason (and fails on some of them, also for no apparent reason). Later I switched to using public symbols.</p>
<div class="highlight"><pre><span></span><span class="n">symbol</span><span class="p">.</span><span class="n">short_name</span> <span class="p">=</span> <span class="n">diaSymbol</span><span class="p">.</span><span class="n">name</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="s">&quot;&quot;</span> <span class="p">:</span> <span class="n">diaSymbol</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
<span class="n">symbol</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">diaSymbol</span><span class="p">.</span><span class="n">undecoratedName</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="n">symbol</span><span class="p">.</span><span class="n">short_name</span> <span class="p">:</span> <span class="n">diaSymbol</span><span class="p">.</span><span class="n">undecoratedName</span><span class="p">;</span>
<span class="n">symbol</span><span class="p">.</span><span class="n">flags</span> <span class="p">=</span> <span class="n">additionalFlags</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="p">==</span> <span class="n">SymTagEnum</span><span class="p">.</span><span class="n">SymTagPublicSymbol</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="n">symbol</span><span class="p">.</span><span class="n">raw_name</span> <span class="p">=</span> <span class="n">symbol</span><span class="p">.</span><span class="n">short_name</span><span class="p">;</span>
</span><span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="c1">//there is no reason this can work, but it often works...</span>
    <span class="kt">string</span> <span class="n">rawName</span><span class="p">;</span>
    <span class="n">IDiaSymbolUndecoratedNameExFlags</span> <span class="n">flags</span> <span class="p">=</span>
        <span class="n">IDiaSymbolUndecoratedNameExFlags</span><span class="p">.</span><span class="n">UNDNAME_32_BIT_DECODE</span> <span class="p">|</span>
        <span class="n">IDiaSymbolUndecoratedNameExFlags</span><span class="p">.</span><span class="n">UNDNAME_TYPE_ONLY</span><span class="p">;</span>
<span class="hll">    <span class="n">diaSymbol</span><span class="p">.</span><span class="n">get_undecoratedNameEx</span><span class="p">((</span><span class="kt">uint</span><span class="p">)</span><span class="n">flags</span><span class="p">,</span> <span class="k">out</span> <span class="n">rawName</span><span class="p">);</span>
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">rawName</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//ignore trashy names like &quot; ?? :: ?? ::Z::_NPEBDI_N * __ptr64 volatile &quot;</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">rawName</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">))</span>
            <span class="n">symbol</span><span class="p">.</span><span class="n">raw_name</span> <span class="p">=</span> <span class="n">rawName</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The first highlighted line simply takes <code>IDiaSymbol.name</code> as raw name, provided that symbol is public. Also I enabled a flag so that public symbols are always extracted and they take precedence, so probably the case of private symbols is not necessary. For a private symbol, <code>IDiaSymbol.name</code> contains partly undecorated name, but calling <code>get_undecoratedNameEx</code> method with weird flag often returns correct result, e.g.:</p>
<div class="highlight"><pre><span></span><span class="n">diaSymbol</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;idList&lt;idVec4&gt;::~idList&lt;idVec4&gt;&quot;</span>
<span class="n">diaSymbol</span><span class="p">.</span><span class="n">get_undecoratedNameEx</span><span class="p">(</span><span class="n">UNDNAME_TYPE_ONLY</span><span class="p">)</span> <span class="p">=</span> <span class="s">&quot;??1?$idList@VidVec4@@@@QEAA@XZ&quot;</span>
</pre></div>


<p>The last problem which I faced with PDB approach was how source filenames were determined for symbols from pdb.
Normally, SymbolSort asks DIA framework about the lines of code which correspond to symbol's address, and if it finds any, then it saves the file path of the first such line. So it seems that the filename of a pdb symbol is exactly the source file where debugger would stop if you put a breakpoint into the symbol. However, if a pdb symbol has no corresponding lines in code, then SymbolSort detects the filename by looking which translation unit provided the code at its address. This is exactly what we tried to avoid in the first place, ignoring the fact that with such mechanism all the duplicates of one symbol get attributed randomly to one of the many source files where it is used. That's why every symbol which has no lines of code in PDB is marked accordingly, so that its filename is later replaced with <code>[unclear_source]</code> to avoid confusion.</p>
<h3 id="classpath-approach"><a class="toclink" href="#classpath-approach">Classpath approach</a></h3>
<p>In a basic case, every code symbol is a method of some class, which is probably contained in other classes or namespaces. This whole construction (e.g. <code>boost::container::map::insert</code>) can be called "classpath", which is similar to file path, but with namespaces and classes instead of directories and files. The idea is to determine classpath of each symbol from its name, then strip its last component (it is usually the method's name), and attribute the symbol to the remaining classpath. Note that we remove the method name for two reasons: 1) we want to obtain per-class statistics, per-method report can be seen elsewhere, and 2) there are too many methods to list them all in the report.</p>
<p>As simple as it may sound, extracting classpath is actually quite hard. Direct processing of fully undecorated symbol name is problematic because it has a lot of excessive info which can get in the way. While it is possible to remove template arguments by simply detecting outer-level angle brackets (which SymbolSort already does), simply splitting the symbol name by "<code>::</code>" won't work even in simple cases. Consider the following examples:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">_Ref_count_base</span> <span class="o">*</span> <span class="o">&amp;&amp;</span> <span class="kr">__cdecl</span> <span class="n">std</span><span class="o">::</span><span class="n">_Move</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">_Ref_count_base</span> <span class="o">*</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">_Ref_count_base</span> <span class="o">*</span> <span class="o">&amp;</span><span class="p">)</span>
<span class="k">public</span><span class="o">:</span> <span class="kr">__cdecl</span> <span class="n">std</span><span class="o">::</span><span class="n">_Wrap_alloc</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;::</span><span class="n">_Wrap_alloc</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">(</span><span class="k">class</span> <span class="nc">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span>
</pre></div>


<p>As you see, return values, function parameters and template arguments can all have internal "<code>::</code>" separators, which must not be used to split the classpath.
Luckily, some of the routines for undecorating symbols support partial undecoration. Calling WinAPI function <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms681400(v=vs.85).aspx">UnDecorateSymbolName</a> with flag <code>UNDNAME_NAME_ONLY</code> results in undecorated name without return value and function parameters:</p>
<div class="highlight"><pre><span></span><span class="n">UnDecorateSymbolName</span><span class="p">(</span><span class="s">&quot;?Warning@idLib@@SAXPEBDZZ&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">:</span>
  <span class="k">public</span><span class="o">:</span> <span class="k">static</span> <span class="kt">void</span> <span class="kr">__cdecl</span> <span class="n">idLib</span><span class="o">::</span><span class="n">Warning</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="n">__ptr64</span><span class="p">,...)</span><span class="s">&quot;</span>
<span class="n">UnDecorateSymbolName</span><span class="p">(</span><span class="s">&quot;?Warning@idLib@@SAXPEBDZZ&quot;</span><span class="p">,</span> <span class="n">UNDNAME_NAME_ONLY</span><span class="p">)</span><span class="o">:</span>
  <span class="n">idLib</span><span class="o">::</span><span class="n">Warning</span>
</pre></div>


<p>The partially undecorated symbol names are much easier to use: in the considered example the result is already a ready-to-use classpath. However, not all the cases are as simple as this one. Here is a hacky regex-based code which handles most of the cases (with tricky symbol names seen in comments):    </p>
<div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">allowedSpecials</span> <span class="p">=</span> <span class="s">@&quot;&lt;=&gt;,\[\]()!~^&amp;|+\-*\/%&quot;</span> <span class="p">+</span> <span class="s">&quot;$&quot;</span><span class="p">;</span>
<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">reClassWord</span> <span class="p">=</span> <span class="s">@&quot;[\w &quot;</span> <span class="p">+</span> <span class="n">allowedSpecials</span> <span class="p">+</span> <span class="s">&quot;]+&quot;</span><span class="p">;</span>
<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">reClassPath</span> <span class="p">=</span> <span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">@&quot;({0}::)*{0}&quot;</span><span class="p">,</span> <span class="n">reClassWord</span><span class="p">);</span>
<span class="k">private</span> <span class="k">static</span> <span class="n">Regex</span> <span class="n">regexClassPath</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Regex</span><span class="p">(</span><span class="s">&quot;^&quot;</span> <span class="p">+</span> <span class="n">reClassPath</span> <span class="p">+</span> <span class="s">&quot;$&quot;</span><span class="p">,</span> <span class="n">RegexOptions</span><span class="p">.</span><span class="n">Compiled</span><span class="p">);</span>
<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">reLocalEnd</span> <span class="p">=</span> <span class="s">@&quot;.*&quot;</span><span class="p">;</span>  <span class="c1">//@&quot;(`.+&#39;|[\w]+(\$0)?)&quot;;</span>
<span class="k">private</span> <span class="k">static</span> <span class="n">Regex</span> <span class="n">regexFuncLocalVar</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Regex</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">@&quot;^`({0})&#39;::`[\d]+&#39;::{1}$&quot;</span><span class="p">,</span> <span class="n">reClassPath</span><span class="p">,</span> <span class="n">reLocalEnd</span><span class="p">));</span>

<span class="k">public</span> <span class="k">static</span> <span class="kt">string</span><span class="p">[]</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">string</span> <span class="n">short_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//(all string constaints)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">short_name</span> <span class="p">==</span> <span class="s">&quot;`string&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="n">short_name</span> <span class="p">};</span>

    <span class="c1">// Array&lt;SharedPtr&lt;Curve&gt;, Allocator&lt;SharedPtr&lt;Curve&gt;&gt;&gt;::Buffer::capacity</span>
    <span class="c1">// std::_Error_objects&lt;int&gt;::_System_object$initializer$</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">regexClassPath</span><span class="p">.</span><span class="n">IsMatch</span><span class="p">(</span><span class="n">short_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="nf">splitByColons</span><span class="p">(</span><span class="n">short_name</span><span class="p">);</span>

    <span class="c1">// std::bad_alloc `RTTI Type Descriptor&#39;</span>
    <span class="k">const</span> <span class="kt">string</span> <span class="n">rttiDescr</span> <span class="p">=</span> <span class="s">&quot; `RTTI Type Descriptor&#39;&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">short_name</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="n">rttiDescr</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">string</span><span class="p">[]</span> <span class="n">res</span> <span class="p">=</span> <span class="n">Run</span><span class="p">(</span><span class="n">short_name</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">short_name</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">rttiDescr</span><span class="p">.</span><span class="n">Length</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">.</span><span class="n">Concat</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="n">rttiDescr</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">}).</span><span class="n">ToArray</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// `CustomHeap::~CustomHeap&#39;::`1&#39;::dtor$0</span>
    <span class="c1">// `std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt;::_Copy&#39;::`1&#39;::catch$0</span>
    <span class="c1">// `CustomHeap&lt;ShapeImpl&gt;::instance&#39;::`2&#39;::some_var</span>
    <span class="c1">// `HeapWrap &lt; ShapeImpl &gt;::Stub::get&#39;::`7&#39;::`local static guard&#39;</span>
    <span class="c1">// `HeapWrap&lt;ShapeImpl&gt;::Stub::get&#39;::`7&#39;::`dynamic atexit destructor for &#39;g_myHeap&#39;&#39;</span>
    <span class="c1">// `Mesh::projectPoints&#39;::`13&#39;::$S1</span>
    <span class="c1">// `GroupElement::getNumElements&#39;::`2&#39;::MyCounter::`vftable&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">regexFuncLocalVar</span><span class="p">.</span><span class="n">IsMatch</span><span class="p">(</span><span class="n">short_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="nf">Run</span><span class="p">(</span><span class="n">regexFuncLocalVar</span><span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">short_name</span><span class="p">).</span><span class="n">Groups</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">);</span>

    <span class="c1">// `dynamic initializer for &#39;BoundingBox::Invalid&#39;&#39;</span>
    <span class="c1">// `dynamic initializer for &#39;std::_Error_objects&lt;int&gt;::_System_object&#39;&#39;</span>
    <span class="c1">// std::`dynamic initializer for &#39;_Tuple_alloc&#39;&#39;</span>
    <span class="c1">// UniquePtr&lt;Service&gt;::`scalar deleting destructor&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">short_name</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">backtickPos</span> <span class="p">=</span> <span class="n">short_name</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="sc">&#39;`&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">backtickPos</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">string</span> <span class="n">prefix</span> <span class="p">=</span> <span class="n">short_name</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">backtickPos</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">quoted</span> <span class="p">=</span> <span class="n">short_name</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">backtickPos</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">short_name</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">backtickPos</span> <span class="p">-</span> <span class="m">2</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">quoted</span><span class="p">.</span><span class="n">Count</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span> <span class="p">==</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span> <span class="p">==</span> <span class="m">2</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">left</span> <span class="p">=</span> <span class="n">quoted</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">);</span>
                <span class="kt">int</span> <span class="n">right</span> <span class="p">=</span> <span class="n">quoted</span><span class="p">.</span><span class="n">LastIndexOf</span><span class="p">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">);</span>
                <span class="n">quoted</span> <span class="p">=</span> <span class="n">quoted</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">left</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">right</span> <span class="p">-</span> <span class="n">left</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="kt">string</span><span class="p">[]</span> <span class="n">quotedWords</span> <span class="p">=</span> <span class="n">Run</span><span class="p">(</span><span class="n">quoted</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">quotedWords</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
            <span class="kt">string</span><span class="p">[]</span> <span class="n">prefixWords</span> <span class="p">=</span> <span class="n">splitByColons</span><span class="p">(</span><span class="n">prefix</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">prefixWords</span><span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="n">prefixWords</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">).</span><span class="n">Concat</span><span class="p">(</span><span class="n">quotedWords</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Unfortunately, we are not yet over with classpath approach =)
It turned out that <code>UnDecorateSymbolName</code> function is no longer maintained. This function belongs to <code>Dbghelp.dll</code> library, the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms679294(v=vs.85).aspx">latest version of which was released in February 2010</a>. It was even before C++11 was out, so this function fails to work on symbols containing rvalue references. There is an updated version called <a href="https://stackoverflow.com/questions/20823277/how-can-i-use-undname-function">_unDName</a>, which is not exposed to public, and even newer version called <a href="https://visualstudio.uservoice.com/forums/121579-visual-studio-ide/suggestions/15672270-publish-header-files-and-documentation-for-undna">__unDNameEx</a>, also for internal usage only. The latter version is used in <a href="https://msdn.microsoft.com/en-us/library/5x49w699.aspx">undname.exe</a> program which is a tool distributed with Visual C++.</p>
<p>In the end I decided to use <code>undname.exe</code> directly by creating a temporary file and spawning it with <code>CreateProcess</code>. The tool allows to put many symbol names into file, in which case it undecorates them all, so there are no performance problems like creating process thousand times. Also, it is safe to assume that user has <code>undname.exe</code> in PATH, since he anyway has to run <code>dumpbin.exe</code> to decode .obj files, which is located in the same directory.</p>
<h2 id="afterword"><a class="toclink" href="#afterword">Afterword</a></h2>
<p>I hope the two improvements will provide a better vision of how much bloat headers and templates produce. In my opinion, both approaches are useful, despite being hacky and not 100% precise. Right now they are available in <a href="https://github.com/stgatilov/SymbolSort">my fork</a>, but I will prepare pull requests in the nearest future.</p>
<p>SymbolSort has two more features which I never tried: analyzing nm dumps and producing diff reports. The latter feature may be very useful in continuous integration if you really care about build times and code bloat.</p>
      
    </div><!-- /.entry-content -->
    <section>
        <div id="post-share-links" class="inline-menu">
            <div>Share on:</div>
            <a href="https://twitter.com/intent/tweet?text=Improvements%20to%20SymbolSort%20tool%20for%20C%2B%2B%20code%20bloat%20analysis&url=https%3A//dirtyhandscoding.github.io/posts/improvements-to-symbolsort-tool-for-c-code-bloat-analysis.html" target="_blank" class="icon-label" title="Share on Twitter">Twitter</a><!--
            --><a href="http://www.facebook.com/sharer/sharer.php?u=https%3A//dirtyhandscoding.github.io/posts/improvements-to-symbolsort-tool-for-c-code-bloat-analysis.html" target="_blank" class="icon-label" title="Share on Facebook">Facebook</a><!--
            --><a href="https://plus.google.com/share?url=https%3A//dirtyhandscoding.github.io/posts/improvements-to-symbolsort-tool-for-c-code-bloat-analysis.html" target="_blank" class="icon-label" title="Share on Google Plus">Google+</a><!--
            --><a href="https://sharetodiaspora.github.io/?title=Improvements%20to%20SymbolSort%20tool%20for%20C%2B%2B%20code%20bloat%20analysis&url=https%3A//dirtyhandscoding.github.io/posts/improvements-to-symbolsort-tool-for-c-code-bloat-analysis.html" target="_blank" class="icon-label" title="Share on Diaspora">Diaspora*</a><!--
            --><a href="https://news.ycombinator.com/submitlink?t=Improvements%20to%20SymbolSort%20tool%20for%20C%2B%2B%20code%20bloat%20analysis&u=https%3A//dirtyhandscoding.github.io/posts/improvements-to-symbolsort-tool-for-c-code-bloat-analysis.html" target="_blank" class="icon-label" title="Share on HackerNews">HackerNews</a><!--
            --><a href="mailto:?subject=Improvements%20to%20SymbolSort%20tool%20for%20C%2B%2B%20code%20bloat%20analysis&amp;body=https%3A//dirtyhandscoding.github.io/posts/improvements-to-symbolsort-tool-for-c-code-bloat-analysis.html" target="_blank" class="icon-label" title="Share via Email">Email</a>
        </div>
    </section>
    
    			<!--<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>-->
		<script src="https://dirtyhandscoding.github.io/theme/js/jquery.min.js"></script>
	<script type="text/javascript" src="https://dirtyhandscoding.github.io/theme/pelican_comment_system/comments.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			CommentSystem.email_user   = "itiswrongemail";
			CommentSystem.email_domain = "outlook.com";

			$('#pcs-comment-form').on("submit",
				function( event )
				{
					event.preventDefault();
					$(location).attr('href', CommentSystem.getMailtoLink("improvements-to-symbolsort-tool-for-c-code-bloat-analysis"));
				}
			);
		});
	</script>

    	<section>
	<div id="pcs-comments-header" class="inline-menu">
	<header>
		<div>Comments (0)</div>
		<button type="button" title="Expand or collapse the comments section" class="icon-label" id="pcs-comments-collapse-button" onclick="CommentSystem.collapsible($('#pcs-comments'), $(this));">
			<span class="nocss">expand</span>
		</button>
			<a href="https://dirtyhandscoding.github.io/feeds/comment.improvements-to-symbolsort-tool-for-c-code-bloat-analysis.atom.xml" class="icon-label">atom feed: comments</a>
	</header>
	</div>
	<div id="pcs-comments">
		<p>There are no comments yet.</p>
	<section>
	<div display="none" id="pcs-comment-notreply-helper" />
	<form id="pcs-comment-form" action="#">
		<fieldset>
		<legend>Add a Comment</legend>
		<div id="pcs-comment-tab-inputs">
			<input type="hidden" id="pcs-comment-form-input-replyto"/>
			<label for="pcs-comment-form-input-name">Name</label>
			<input  id="pcs-comment-form-input-name" type="text" size="40" placeholder="Enter your name or nickname" />
			<br/>
			<label for="pcs-comment-form-input-website">Website</label>
			<input  id="pcs-comment-form-input-website" type="text" size="40" placeholder="Enter your website (optional)" />
			<br/>
			<label for="pcs-comment-form-input-empty">Empty</label>
			<input  id="pcs-comment-form-input-empty" type="text" size="30" placeholder="Do NOT enter anything here!" />
			<label   for="pcs-comment-form-input-textarea">Your Comment</label>
			<br/>
			<textarea id="pcs-comment-form-input-textarea" rows="7" cols="40" placeholder="Enter your comment (markdown is allowed)"></textarea>
		</div>
		<div id="pcs-comment-tab-message" style="display:none">
			<textarea readonly rows="10" cols="40"></textarea>
		</div>

		<button type="submit"
				id="pcs-comment-form-button-submit"
				title="Create mailto link and open it in default email client &#10;Note: you have to send the email to post comment"
				>Post via email</button>
		<button type="button"
				id="pcs-comment-form-button-message"
				title="See the text of email message to be sent &#10;Note: you can copy it and send manually"
				onclick="CommentSystem.viewEmail(&quot;improvements-to-symbolsort-tool-for-c-code-bloat-analysis&quot;);"
				>View email text</button>
		<a target="_blank"
				id="pcs-comment-gmail-config-help"
				title="How to configure Chrome to open mailto links in Gmail..."
				href="https://productforums.google.com/forum/#!topic/gmail/JtWVPbUfh-o"
				>?</a>
		</fieldset>

		<!--			<a href="https://dirtyhandscoding.github.io/feeds/comment.improvements-to-symbolsort-tool-for-c-code-bloat-analysis.atom.xml">
				Comment Atom Feed
			</a>
-->
	</form>
	<script>CommentSystem.displayReplyTo();</script>
</section>

	</div>
	<script>
		$('#pcs-comments').css({display: "none"});
		$('#pcs-comments-collapse-button').addClass('collapsed');
	</script>
</section>

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            <li><a href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">rss feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, customized to personal taste.</p>
        </footer><!-- /#contentinfo -->

</body>
</html>